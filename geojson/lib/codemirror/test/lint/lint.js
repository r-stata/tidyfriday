var fs=require("fs"),acorn=require("./acorn.js"),walk=require("./walk.js"),scopePasser=walk.make({ScopeBody:function(e,n,r){r(e,e.scope)}});function checkFile(n){var e,r=fs.readFileSync(n,"utf8");(e=r.match(/[\x00-\x08\x0b\x0c\x0e-\x19\uFEFF\t]|[ \t]\n/))&&fail(("\t"==e[0]?"Found tab character":-1<e[0].indexOf("\n")?"Trailing whitespace":"Undesirable character "+e[0].charCodeAt(0))+" at line "+(l=acorn.getLineInfo(r,e.index)).line+", column "+l.column,{source:n});try{var c=acorn.parse(r,{locations:!0,ecmaVersion:3,strictSemicolons:!0,allowTrailingCommas:!1,forbidReserved:!0,sourceFile:n})}catch(e){return void fail(e.message,{source:n})}var i=[],a=(walk.simple(c,{ScopeBody:function(e,n){e.scope=n,i.push(n)}},walk.scopeVisitor,{vars:Object.create(null)}),Object.create(null));function o(e,n){"Identifier"!=e.type||e.name in a||function(e,n){for(var r=n;r;r=r.prev)if(e in r.vars)return 1}(e.name,n)||(a[e.name]=!0,fail("Assignment to global variable",e.loc))}walk.simple(c,{UpdateExpression:function(e,n){o(e.argument,n)},AssignmentExpression:function(e,n){o(e.left,n)},Identifier:function(e,n){for(var r=n;r;r=r.prev)if(e.name in r.vars)return void(r.vars[e.name].used=!0)},FunctionExpression:function(e){e.id&&fail("Named function expression",e.loc)}},scopePasser);for(var s=0;s<i.length;++s){var t,l,f=i[s];for(t in f.vars)(l=f.vars[t]).used||"catch clause"==l.type||"function name"==l.type||"_"==t.charAt(0)||fail("Unused "+l.type+" "+t,l.node.loc)}}var failed=!1;function fail(e,n){n.start&&(e+=" ("+n.start.line+":"+n.start.column+")"),console.log(n.source+": "+e),failed=!0}function checkDir(r){fs.readdirSync(r).forEach(function(e){var n=r+"/"+e;/\.js$/.test(e)?checkFile(n):"dep"!=e&&fs.lstatSync(n).isDirectory()&&checkDir(n)})}exports.checkDir=checkDir,exports.checkFile=checkFile,exports.success=function(){return!failed};
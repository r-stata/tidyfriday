var Pos=CodeMirror.Pos;function forEach(e,o){for(var t=0,n=e.length;t<n;++t)o(e[t])}function addDoc(e,o,t){for(var n=[],s="",a=0;a<o;++a)s+="x";for(a=0;a<t;++a)n.push(s);e.setValue(n.join("\n"))}function byClassName(e,o){var s,a;return e.getElementsByClassName?e.getElementsByClassName(o):(s=[],a=new RegExp("\\b"+o+"\\b"),function e(o){if(3!=o.nodeType){a.test(o.className)&&s.push(o);for(var t=0,n=o.childNodes.length;t<n;++t)e(o.childNodes[t])}}(e),s)}var ie_lt8=/MSIE [1-7]\b/.test(navigator.userAgent),mac=/Mac/.test(navigator.platform),phantom=/PhantomJS/.test(navigator.userAgent),opera=/Opera\/\./.test(navigator.userAgent),opera_version=(opera_version=opera&&navigator.userAgent.match(/Version\/(\d+\.\d+)/))&&Number(opera_version),opera_lt10=opera&&(!opera_version||opera_version<10);function foldLines(e,o,t,n){return e.markText(Pos(o,0),Pos(t-1),{inclusiveLeft:!0,inclusiveRight:!0,collapsed:!0,clearOnEnter:n})}namespace="core_",test("core_fromTextArea",function(){var e=document.getElementById("code"),o=(e.value="CONTENT",CodeMirror.fromTextArea(e));is(!e.offsetHeight),eq(o.getValue(),"CONTENT"),o.setValue("foo\nbar"),eq(o.getValue(),"foo\nbar"),o.save(),is(/^foo\r?\nbar$/.test(e.value)),o.setValue("xxx"),o.toTextArea(),is(e.offsetHeight),eq(e.value,"xxx")}),testCM("getRange",function(e){eq(e.getLine(0),"1234"),eq(e.getLine(1),"5678"),eq(e.getLine(2),null),eq(e.getLine(-1),null),eq(e.getRange(Pos(0,0),Pos(0,3)),"123"),eq(e.getRange(Pos(0,-1),Pos(0,200)),"1234"),eq(e.getRange(Pos(0,2),Pos(1,2)),"34\n56"),eq(e.getRange(Pos(1,2),Pos(100,0)),"78")},{value:"1234\n5678"}),testCM("replaceRange",function(e){eq(e.getValue(),""),e.replaceRange("foo\n",Pos(0,0)),eq(e.getValue(),"foo\n"),e.replaceRange("a\nb",Pos(0,1)),eq(e.getValue(),"fa\nboo\n"),eq(e.lineCount(),3),e.replaceRange("xyzzy",Pos(0,0),Pos(1,1)),eq(e.getValue(),"xyzzyoo\n"),e.replaceRange("abc",Pos(0,0),Pos(10,0)),eq(e.getValue(),"abc"),eq(e.lineCount(),1)}),testCM("selection",function(e){e.setSelection(Pos(0,4),Pos(2,2)),is(e.somethingSelected()),eq(e.getSelection(),"11\n222222\n33"),eqPos(e.getCursor(!1),Pos(2,2)),eqPos(e.getCursor(!0),Pos(0,4)),e.setSelection(Pos(1,0)),is(!e.somethingSelected()),eq(e.getSelection(),""),eqPos(e.getCursor(!0),Pos(1,0)),e.replaceSelection("abc"),eq(e.getSelection(),"abc"),eq(e.getValue(),"111111\nabc222222\n333333"),e.replaceSelection("def","end"),eq(e.getSelection(),""),eqPos(e.getCursor(!0),Pos(1,3)),e.setCursor(Pos(2,1)),eqPos(e.getCursor(!0),Pos(2,1)),e.setCursor(1,2),eqPos(e.getCursor(!0),Pos(1,2))},{value:"111111\n222222\n333333"}),testCM("extendSelection",function(e){e.setExtending(!0),addDoc(e,10,10),e.setSelection(Pos(3,5)),eqPos(e.getCursor("head"),Pos(3,5)),eqPos(e.getCursor("anchor"),Pos(3,5)),e.setSelection(Pos(2,5),Pos(5,5)),eqPos(e.getCursor("head"),Pos(5,5)),eqPos(e.getCursor("anchor"),Pos(2,5)),eqPos(e.getCursor("start"),Pos(2,5)),eqPos(e.getCursor("end"),Pos(5,5)),e.setSelection(Pos(5,5),Pos(2,5)),eqPos(e.getCursor("head"),Pos(2,5)),eqPos(e.getCursor("anchor"),Pos(5,5)),eqPos(e.getCursor("start"),Pos(2,5)),eqPos(e.getCursor("end"),Pos(5,5)),e.extendSelection(Pos(3,2)),eqPos(e.getCursor("head"),Pos(3,2)),eqPos(e.getCursor("anchor"),Pos(5,5)),e.extendSelection(Pos(6,2)),eqPos(e.getCursor("head"),Pos(6,2)),eqPos(e.getCursor("anchor"),Pos(5,5)),e.extendSelection(Pos(6,3),Pos(6,4)),eqPos(e.getCursor("head"),Pos(6,4)),eqPos(e.getCursor("anchor"),Pos(5,5)),e.extendSelection(Pos(0,3),Pos(0,4)),eqPos(e.getCursor("head"),Pos(0,3)),eqPos(e.getCursor("anchor"),Pos(5,5)),e.extendSelection(Pos(4,5),Pos(6,5)),eqPos(e.getCursor("head"),Pos(6,5)),eqPos(e.getCursor("anchor"),Pos(4,5)),e.setExtending(!1),e.extendSelection(Pos(0,3),Pos(0,4)),eqPos(e.getCursor("head"),Pos(0,4)),eqPos(e.getCursor("anchor"),Pos(0,3))}),testCM("lines",function(e){eq(e.getLine(0),"111111"),eq(e.getLine(1),"222222"),eq(e.getLine(-1),null),e.removeLine(1),e.setLine(1,"abc"),eq(e.getValue(),"111111\nabc")},{value:"111111\n222222\n333333"}),testCM("indent",function(e){e.indentLine(1),eq(e.getLine(1),"   blah();"),e.setOption("indentUnit",8),e.indentLine(1),eq(e.getLine(1),"\tblah();"),e.setOption("indentUnit",10),e.setOption("tabSize",4),e.indentLine(1),eq(e.getLine(1),"\t\t  blah();")},{value:"if (x) {\nblah();\n}",indentUnit:3,indentWithTabs:!0,tabSize:8}),testCM("indentByNumber",function(e){e.indentLine(0,2),eq(e.getLine(0),"  foo"),e.indentLine(0,-200),eq(e.getLine(0),"foo"),e.setSelection(Pos(0,0),Pos(1,2)),e.indentSelection(3),eq(e.getValue(),"   foo\n   bar\nbaz")},{value:"foo\nbar\nbaz"}),test("core_defaults",function(){var e={},o=CodeMirror.defaults;for(s in o)e[s]=o[s];o.indentUnit=5,o.value="uu",o.enterMode="keep",o.tabindex=55;var t=document.getElementById("testground"),n=CodeMirror(t);try{eq(n.getOption("indentUnit"),5),n.setOption("indentUnit",10),eq(o.indentUnit,5),eq(n.getValue(),"uu"),eq(n.getOption("enterMode"),"keep"),eq(n.getInputField().tabIndex,55)}finally{for(var s in e)o[s]=e[s];t.removeChild(n.getWrapperElement())}}),testCM("lineInfo",function(e){eq(e.lineInfo(-1),null);var o=document.createElement("span"),t=e.setGutterMarker(1,"FOO",o),n=e.lineInfo(1);eq(n.text,"222222"),eq(n.gutterMarkers.FOO,o),eq(n.line,1),eq(e.lineInfo(2).gutterMarkers,null),e.setGutterMarker(t,"FOO",null),eq(e.lineInfo(1).gutterMarkers,null),e.setGutterMarker(1,"FOO",o),e.setGutterMarker(0,"FOO",o),e.clearGutter("FOO"),eq(e.lineInfo(0).gutterMarkers,null),eq(e.lineInfo(1).gutterMarkers,null)},{value:"111111\n222222\n333333"}),testCM("coords",function(e){e.setSize(null,100),addDoc(e,32,200);var o=e.charCoords(Pos(0,0)),t=e.charCoords(Pos(200,30)),t=(is(o.left<t.left),is(o.top<t.top),is(o.top<o.bottom),e.scrollTo(null,100),e.charCoords(Pos(0,0)));is(o.top>t.top),eq(o.left,t.left)}),testCM("coordsChar",function(e){addDoc(e,35,70);for(var o=0;o<2;++o)for(var t=o?"local":"page",n=0;n<=35;n+=5)for(var s=0;s<70;s+=5){e.setCursor(s,n);var a=e.charCoords(Pos(s,n),t),a=e.coordsChar({left:a.left+1,top:a.top+1},t);eqPos(a,Pos(s,n))}},{lineNumbers:!0}),testCM("posFromIndex",function(e){e.setValue("This function should\nconvert a zero based index\nto line and ch.");for(var o=[{index:-1,line:0,ch:0},{index:0,line:0,ch:0},{index:10,line:0,ch:10},{index:39,line:1,ch:18},{index:55,line:2,ch:7},{index:63,line:2,ch:15},{index:64,line:2,ch:15}],t=0;t<o.length;t++){var n=o[t],s=e.posFromIndex(n.index);eq(s.line,n.line),eq(s.ch,n.ch),0<=n.index&&n.index<64&&eq(e.indexFromPos(s),n.index)}}),testCM("undo",function(e){e.setLine(0,"def"),eq(e.historySize().undo,1),e.undo(),eq(e.getValue(),"abc"),eq(e.historySize().undo,0),eq(e.historySize().redo,1),e.redo(),eq(e.getValue(),"def"),eq(e.historySize().undo,1),eq(e.historySize().redo,0),e.setValue("1\n\n\n2"),e.clearHistory(),eq(e.historySize().undo,0);for(var o=0;o<20;++o)e.replaceRange("a",Pos(0,0)),e.replaceRange("b",Pos(3,0));eq(e.historySize().undo,40);for(o=0;o<40;++o)e.undo();eq(e.historySize().redo,40),eq(e.getValue(),"1\n\n\n2")},{value:"abc"}),testCM("undoDepth",function(e){e.replaceRange("d",Pos(0)),e.replaceRange("e",Pos(0)),e.replaceRange("f",Pos(0)),e.undo(),e.undo(),e.undo(),eq(e.getValue(),"abcd")},{value:"abc",undoDepth:2}),testCM("undoDoesntClearValue",function(e){e.undo(),eq(e.getValue(),"x")},{value:"x"}),testCM("undoMultiLine",function(e){e.operation(function(){e.replaceRange("x",Pos(0,0)),e.replaceRange("y",Pos(1,0))}),e.undo(),eq(e.getValue(),"abc\ndef\nghi"),e.operation(function(){e.replaceRange("y",Pos(1,0)),e.replaceRange("x",Pos(0,0))}),e.undo(),eq(e.getValue(),"abc\ndef\nghi"),e.operation(function(){e.replaceRange("y",Pos(2,0)),e.replaceRange("x",Pos(1,0)),e.replaceRange("z",Pos(2,0))}),e.undo(),eq(e.getValue(),"abc\ndef\nghi",3)},{value:"abc\ndef\nghi"}),testCM("undoComposite",function(e){e.replaceRange("y",Pos(1)),e.operation(function(){e.replaceRange("x",Pos(0)),e.replaceRange("z",Pos(2))}),eq(e.getValue(),"ax\nby\ncz\n"),e.undo(),eq(e.getValue(),"a\nby\nc\n"),e.undo(),eq(e.getValue(),"a\nb\nc\n"),e.redo(),e.redo(),eq(e.getValue(),"ax\nby\ncz\n")},{value:"a\nb\nc\n"}),testCM("undoSelection",function(e){e.setSelection(Pos(0,2),Pos(0,4)),e.replaceSelection(""),e.setCursor(Pos(1,0)),e.undo(),eqPos(e.getCursor(!0),Pos(0,2)),eqPos(e.getCursor(!1),Pos(0,4)),e.setCursor(Pos(1,0)),e.redo(),eqPos(e.getCursor(!0),Pos(0,2)),eqPos(e.getCursor(!1),Pos(0,2))},{value:"abcdefgh\n"}),testCM("markTextSingleLine",function(t){forEach([{a:0,b:1,c:"",f:2,t:5},{a:0,b:4,c:"",f:0,t:2},{a:1,b:2,c:"x",f:3,t:6},{a:4,b:5,c:"",f:3,t:5},{a:4,b:5,c:"xx",f:3,t:7},{a:2,b:5,c:"",f:2,t:3},{a:2,b:5,c:"abcd",f:6,t:7},{a:2,b:6,c:"x",f:null,t:null},{a:3,b:6,c:"",f:null,t:null},{a:0,b:9,c:"hallo",f:null,t:null},{a:4,b:6,c:"x",f:3,t:4},{a:4,b:8,c:"",f:3,t:4},{a:6,b:6,c:"a",f:3,t:6},{a:8,b:9,c:"",f:3,t:6}],function(e){t.setValue("1234567890");var o=t.markText(Pos(0,3),Pos(0,6),{className:"foo"}),o=(t.replaceRange(e.c,Pos(0,e.a),Pos(0,e.b)),o.find());eq(o&&o.from.ch,e.f),eq(o&&o.to.ch,e.t)})}),testCM("markTextMultiLine",function(t){function n(e){return e&&Pos(e[0],e[1])}forEach([{a:[0,0],b:[0,5],c:"",f:[0,0],t:[2,5]},{a:[0,0],b:[0,5],c:"foo\n",f:[1,0],t:[3,5]},{a:[0,1],b:[0,10],c:"",f:[0,1],t:[2,5]},{a:[0,5],b:[0,6],c:"x",f:[0,6],t:[2,5]},{a:[0,0],b:[1,0],c:"",f:[0,0],t:[1,5]},{a:[0,6],b:[2,4],c:"",f:[0,5],t:[0,7]},{a:[0,6],b:[2,4],c:"aa",f:[0,5],t:[0,9]},{a:[1,2],b:[1,8],c:"",f:[0,5],t:[2,5]},{a:[0,5],b:[2,5],c:"xx",f:null,t:null},{a:[0,0],b:[2,10],c:"x",f:null,t:null},{a:[1,5],b:[2,5],c:"",f:[0,5],t:[1,5]},{a:[2,0],b:[2,3],c:"",f:[0,5],t:[2,2]},{a:[2,5],b:[3,0],c:"a\nb",f:[0,5],t:[2,5]},{a:[2,3],b:[3,0],c:"x",f:[0,5],t:[2,3]},{a:[1,1],b:[1,9],c:"1\n2\n3",f:[0,5],t:[4,5]}],function(e){t.setValue("aaaaaaaaaa\nbbbbbbbbbb\ncccccccccc\ndddddddd\n");var o=t.markText(Pos(0,5),Pos(2,5),{className:"CodeMirror-matchingbracket"}),o=(t.replaceRange(e.c,n(e.a),n(e.b)),o.find());eqPos(o&&o.from,n(e.f)),eqPos(o&&o.to,n(e.t))})}),testCM("markTextUndo",function(e){var o=e.markText(Pos(0,1),Pos(0,3),{className:"CodeMirror-matchingbracket"}),t=e.markText(Pos(0,0),Pos(2,1),{className:"CodeMirror-matchingbracket"}),n=e.setBookmark(Pos(1,5)),s=(e.operation(function(){e.replaceRange("foo",Pos(0,2)),e.replaceRange("bar\nbaz\nbug\n",Pos(2,0),Pos(3,0))}),e.getValue()),o=(e.setValue(""),eq(o.find(),null),eq(t.find(),null),eq(n.find(),null),e.undo(),eqPos(n.find(),Pos(1,5),"still there"),e.undo(),o.find()),t=t.find();eqPos(o.from,Pos(0,1)),eqPos(o.to,Pos(0,3)),eqPos(t.from,Pos(0,0)),eqPos(t.to,Pos(2,1)),eqPos(n.find(),Pos(1,5)),e.redo(),e.redo(),eq(n.find(),null),e.undo(),eqPos(n.find(),Pos(1,5)),eq(e.getValue(),s)},{value:"1234\n56789\n00\n"}),testCM("markTextStayGone",function(e){var o=e.markText(Pos(0,0),Pos(0,1));e.replaceRange("hi",Pos(0,2)),o.clear(),e.undo(),eq(o.find(),null)},{value:"hello"}),testCM("undoPreservesNewMarks",function(e){e.markText(Pos(0,3),Pos(0,4)),e.markText(Pos(1,1),Pos(1,3)),e.replaceRange("",Pos(0,3),Pos(3,1));var o=e.markText(Pos(0,0),Pos(0,1)),t=e.markText(Pos(0,5),Pos(0,6)),n=e.markText(Pos(0,2),Pos(0,4)),o=(e.undo(),eqPos(o.find().from,Pos(0,0)),eqPos(o.find().to,Pos(0,1)),eqPos(t.find().from,Pos(3,3)),eqPos(t.find().to,Pos(3,4)),eqPos(n.find().from,Pos(0,2)),eqPos(n.find().to,Pos(3,2)),e.findMarksAt(Pos(2,2)));eq(o.length,1),eq(o[0],n)},{value:"aaaa\nbbbb\ncccc\ndddd"}),testCM("markClearBetween",function(e){e.setValue("aaa\nbbb\nccc\nddd\n"),e.markText(Pos(0,0),Pos(2)),e.replaceRange("aaa\nbbb\nccc",Pos(0,0),Pos(2)),eq(e.findMarksAt(Pos(1,1)).length,0)}),testCM("deleteSpanCollapsedInclusiveLeft",function(e){var o=Pos(1,0),t=Pos(1,1);e.markText(o,t,{collapsed:!0,inclusiveLeft:!0});e.replaceRange("",o,t)},{value:"abc\nX\ndef"}),testCM("bookmark",function(t){function n(e){return e&&Pos(e[0],e[1])}forEach([{a:[1,0],b:[1,1],c:"",d:[1,4]},{a:[1,1],b:[1,1],c:"xx",d:[1,7]},{a:[1,4],b:[1,5],c:"ab",d:[1,6]},{a:[1,4],b:[1,6],c:"",d:null},{a:[1,5],b:[1,6],c:"abc",d:[1,5]},{a:[1,6],b:[1,8],c:"",d:[1,5]},{a:[1,4],b:[1,4],c:"\n\n",d:[3,1]},{bm:[1,9],a:[1,1],b:[1,1],c:"\n",d:[2,8]}],function(e){t.setValue("1234567890\n1234567890\n1234567890");var o=t.setBookmark(n(e.bm)||Pos(1,5));t.replaceRange(e.c,n(e.a),n(e.b)),eqPos(o.find(),n(e.d))})}),testCM("bookmarkInsertLeft",function(e){var o=e.setBookmark(Pos(0,2),{insertLeft:!1}),t=e.setBookmark(Pos(0,2),{insertLeft:!0});e.setCursor(Pos(0,2)),e.replaceSelection("hi"),eqPos(o.find(),Pos(0,2)),eqPos(t.find(),Pos(0,4)),e.replaceRange("",Pos(0,4),Pos(0,5)),e.replaceRange("",Pos(0,2),Pos(0,4)),e.replaceRange("",Pos(0,1),Pos(0,2)),eqPos(o.find(),Pos(0,1)),eqPos(t.find(),Pos(0,1))},{value:"abcdef"}),testCM("getAllMarks",function(e){addDoc(e,10,10);var o=e.setBookmark(Pos(0,2)),t=(e.markText(Pos(0,2),Pos(3,2)),e.markText(Pos(1,2),Pos(1,8)));e.markText(Pos(8,0),Pos(9,0));eq(e.getAllMarks().length,4),o.clear(),t.clear(),eq(e.getAllMarks().length,2)}),testCM("bug577",function(e){e.setValue("a\nb"),e.clearHistory(),e.setValue("fooooo"),e.undo()}),testCM("scrollSnap",function(e){e.setSize(100,100),addDoc(e,200,200),e.setCursor(Pos(100,180));var o=e.getScrollInfo();is(0<o.left&&0<o.top),e.setCursor(Pos(0,0)),o=e.getScrollInfo(),is(0==o.left&&0==o.top,"scrolled clean to top"),e.setCursor(Pos(100,180)),e.setCursor(Pos(199,0)),o=e.getScrollInfo(),is(0==o.left&&o.top+2>o.height-e.getScrollerElement().clientHeight,"scrolled clean to bottom")}),testCM("scrollIntoView",function(t){var n;function e(e,o){e=Pos(e,o),t.scrollIntoView(e),o=t.charCoords(e,"window");is(o.left>=n.left&&o.right<=n.right&&o.top>=n.top&&o.bottom<=n.bottom)}phantom||(n=t.getWrapperElement().getBoundingClientRect(),addDoc(t,200,200),e(199,199),e(0,0),e(100,100),e(199,0),e(0,199),e(100,100))}),testCM("selectionPos",function(e){if(!phantom){e.setSize(100,100),addDoc(e,200,100),e.setSelection(Pos(1,100),Pos(98,100));for(var o,t,n,s=e.charCoords(Pos(0,200),"local").left,a=(e.charCoords(Pos(99)).top-e.charCoords(Pos(0)).top)/100,r=(e.scrollTo(0,0),byClassName(e.getWrapperElement(),"CodeMirror-selected")),i=e.getWrapperElement().getBoundingClientRect(),l=0,c=r.length;l<c;++l){var u=r[l].getBoundingClientRect(),d=u.left-i.left<30,g=u.right-u.left,P=u.right-i.left>.8*s;d&&P?(o=!0,is(u.bottom-u.top>90*a,"middle high"),is(.9*s<g,"middle wide")):(is(.4*s<g,"top/bot wide enough"),is(g<.6*s,"top/bot slim enough"),d?(n=!0,is(u.top-i.top>96*a,"bot below")):P&&(t=!0,is(u.top-i.top<2.1*a,"top above")))}is(t&&n&&o,"all parts")}},null),testCM("restoreHistory",function(e){e.setValue("abc\ndef"),e.setLine(1,"hello"),e.setLine(0,"goop"),e.undo();var o=e.getValue(),t=e.getHistory();window.JSON&&(t=JSON.parse(JSON.stringify(t))),eq(o,"abc\nhello"),e.setValue(""),e.clearHistory(),eq(e.historySize().undo,0),e.setValue(o),e.setHistory(t),e.redo(),eq(e.getValue(),"goop\nhello"),e.undo(),e.undo(),eq(e.getValue(),"abc\ndef")}),testCM("doubleScrollbar",function(e){var o=document.body.appendChild(document.createElement("p")),t=(o.style.cssText="height: 50px; overflow: scroll; width: 50px",o.offsetWidth+1-o.clientWidth);document.body.removeChild(o),t<2||(e.setSize(null,100),addDoc(e,1,300),o=e.getWrapperElement(),is(o.offsetWidth-byClassName(o,"CodeMirror-lines")[0].offsetWidth<=1.5*t))}),testCM("weirdLinebreaks",function(e){e.setValue("foo\nbar\rbaz\r\nquux\n\rplop"),is(e.getValue(),"foo\nbar\nbaz\nquux\n\nplop"),is(e.lineCount(),6),e.setValue("\n\n"),is(e.lineCount(),3)}),testCM("setSize",function(e){e.setSize(100,100);var o=e.getWrapperElement();is(o.offsetWidth,100),is(o.offsetHeight,100),e.setSize("100%","3em"),is(o.style.width,"100%"),is(o.style.height,"3em"),e.setSize(null,40),is(o.style.width,"100%"),is(o.style.height,"40px")}),testCM("collapsedLines",function(e){addDoc(e,4,10);var o=foldLines(e,4,5),t=0;CodeMirror.on(o,"clear",function(){t++}),e.setCursor(Pos(3,0)),CodeMirror.commands.goLineDown(e),eqPos(e.getCursor(),Pos(5,0)),e.setLine(3,"abcdefg"),e.setCursor(Pos(3,6)),CodeMirror.commands.goLineDown(e),eqPos(e.getCursor(),Pos(5,4)),e.setLine(3,"ab"),e.setCursor(Pos(3,2)),CodeMirror.commands.goLineDown(e),eqPos(e.getCursor(),Pos(5,2)),e.operation(function(){o.clear(),o.clear()}),eq(t,1)}),testCM("collapsedRangeCoordsChar",function(e){var o=e.charCoords(Pos(1,3)),t=(o.left+=2,o.top+=2,{collapsed:!0,inclusiveLeft:!0,inclusiveRight:!0}),n=e.markText(Pos(0,0),Pos(2,0),t),n=(eqPos(e.coordsChar(o),Pos(3,3)),n.clear(),e.markText(Pos(0,0),Pos(1,1),t)),s=e.markText(Pos(1,1),Pos(2,0),t),n=(eqPos(e.coordsChar(o),Pos(3,3)),n.clear(),s.clear(),e.markText(Pos(0,0),Pos(1,6),t));eqPos(e.coordsChar(o),Pos(3,3))},{value:"123456\nabcdef\nghijkl\nmnopqr\n"}),testCM("hiddenLinesAutoUnfold",function(e){var o=foldLines(e,1,3,!0),t=0;CodeMirror.on(o,"clear",function(){t++}),e.setCursor(Pos(3,0)),eq(t,0),e.execCommand("goCharLeft"),eq(t,1),o=foldLines(e,1,3,!0),CodeMirror.on(o,"clear",function(){t++}),eqPos(e.getCursor(),Pos(3,0)),e.setCursor(Pos(0,3)),e.execCommand("goCharRight"),eq(t,2)},{value:"abc\ndef\nghi\njkl"}),testCM("hiddenLinesSelectAll",function(e){addDoc(e,4,20),foldLines(e,0,10),foldLines(e,11,20),CodeMirror.commands.selectAll(e),eqPos(e.getCursor(!0),Pos(10,0)),eqPos(e.getCursor(!1),Pos(10,4))}),testCM("everythingFolded",function(e){function o(){e.triggerOnKeyDown({type:"keydown",keyCode:13,preventDefault:function(){},stopPropagation:function(){}})}addDoc(e,2,2);var t=foldLines(e,0,2);o(),eq(e.getValue(),"xx\nxx"),t.clear(),t=foldLines(e,0,2,!0),eq(t.find(),null),o(),eq(e.getValue(),"\nxx\nxx")}),testCM("structuredFold",function(e){var o,t;phantom||(addDoc(e,4,8),o=e.markText(Pos(1,2),Pos(6,2),{replacedWith:document.createTextNode("Q")}),e.setCursor(0,3),CodeMirror.commands.goLineDown(e),eqPos(e.getCursor(),Pos(6,2)),CodeMirror.commands.goCharLeft(e),eqPos(e.getCursor(),Pos(1,2)),CodeMirror.commands.delCharAfter(e),eq(e.getValue(),"xxxx\nxxxx\nxxxx"),addDoc(e,4,8),o=e.markText(Pos(1,2),Pos(6,2),{replacedWith:document.createTextNode("M"),clearOnEnter:!0}),t=0,CodeMirror.on(o,"clear",function(){++t}),e.setCursor(0,3),CodeMirror.commands.goLineDown(e),eqPos(e.getCursor(),Pos(6,2)),CodeMirror.commands.goCharLeft(e),eqPos(e.getCursor(),Pos(6,1)),eq(t,1),o.clear(),eq(t,1),(o=e.markText(Pos(1,2),Pos(6,2),{replacedWith:document.createTextNode("Q"),clearOnEnter:!0})).clear(),e.setCursor(1,2),CodeMirror.commands.goCharRight(e),eqPos(e.getCursor(),Pos(1,3)),o=e.markText(Pos(2,0),Pos(4,4),{replacedWith:document.createTextNode("M")}),e.setCursor(1,0),CodeMirror.commands.goLineDown(e),eqPos(e.getCursor(),Pos(2,0)))},null),testCM("nestedFold",function(s){function e(e,o,t,n){return s.markText(Pos(e,o),Pos(t,n),{collapsed:!0})}addDoc(s,10,3);e(0,6,1,3);var o=e(0,2,1,8),t=e(0,1,2,3),n=e(0,5,0,6);s.setCursor(0,1),CodeMirror.commands.goCharRight(s),eqPos(s.getCursor(),Pos(2,3)),n.clear(),CodeMirror.commands.goCharLeft(s),eqPos(s.getCursor(),Pos(0,1)),t.clear(),CodeMirror.commands.goCharRight(s),eqPos(s.getCursor(),Pos(0,2)),CodeMirror.commands.goCharRight(s),eqPos(s.getCursor(),Pos(1,8)),o.clear(),CodeMirror.commands.goCharLeft(s),eqPos(s.getCursor(),Pos(1,7)),s.setCursor(0,5),CodeMirror.commands.goCharRight(s),eqPos(s.getCursor(),Pos(0,6)),CodeMirror.commands.goCharRight(s),eqPos(s.getCursor(),Pos(1,3))}),testCM("badNestedFold",function(e){var o;addDoc(e,4,4),e.markText(Pos(0,2),Pos(3,2),{collapsed:!0});try{e.markText(Pos(0,1),Pos(0,3),{collapsed:!0})}catch(e){o=e}is(o instanceof Error,"no error"),is(/overlap/i.test(o.message),"wrong error")}),testCM("wrappingInlineWidget",function(e){e.setSize("11em");var o=document.createElement("span"),o=(o.style.color="red",o.innerHTML="one two three four",e.markText(Pos(0,6),Pos(0,9),{replacedWith:o}),e.cursorCoords(Pos(0,0))),t=e.cursorCoords(Pos(0,10)),n=(is(o.top<t.top),is(o.bottom<t.bottom),e.cursorCoords(Pos(0,6))),s=e.cursorCoords(Pos(0,9));eq(n.top,o.top),eq(n.bottom,o.bottom),eq(s.top,t.top),eq(s.bottom,t.bottom),e.replaceRange("",Pos(0,9),Pos(0)),s=e.cursorCoords(Pos(0,9)),eq(s.top,t.top),eq(s.bottom,t.bottom)},{value:"1 2 3 xxx 4",lineWrapping:!0}),testCM("inlineWidget",function(e){var o=e.setBookmark(Pos(0,2),{widget:document.createTextNode("uu")});e.setCursor(0,2),CodeMirror.commands.goLineDown(e),eqPos(e.getCursor(),Pos(1,4)),e.setCursor(0,2),e.replaceSelection("hi"),eqPos(o.find(),Pos(0,2)),e.setCursor(0,1),e.replaceSelection("ay"),eqPos(o.find(),Pos(0,4)),eq(e.getLine(0),"uayuhiuu")},{value:"uuuu\nuuuuuu"}),testCM("wrappingAndResizing",function(t){t.setSize(null,"auto"),t.setOption("lineWrapping",!0);var e=t.getWrapperElement(),o=e.offsetHeight,n="xxx xxx xxx xxx xxx";t.setValue(n);for(var s=10,a=t.charCoords(Pos(0,18),"div").right;;a+=s)if(t.setSize(a),e.offsetHeight<=o*(opera_lt10?1.2:1.5)){if(10!=s)break;a-=10,s=1}t.setCursor(Pos(0,n.length)),eq(e.offsetHeight,o),t.replaceSelection("x"),is(e.offsetHeight>o,"wrapping happens"),t.setValue(n+"\n"+n+"\n"),t.getScrollerElement().style.maxHeight="100px",t.replaceRange("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n!\n",Pos(2,0)),forEach([Pos(0,n.length),Pos(0,n.length-1),Pos(0,0),Pos(1,n.length),Pos(1,n.length-1)],function(e){var o=t.charCoords(e);eqPos(e,t.coordsChar({left:o.left+2,top:o.top+5}))})},null,ie_lt8),testCM("measureEndOfLine",function(e){e.setSize(null,"auto");for(var o=byClassName(e.getWrapperElement(),"CodeMirror-lines")[0].firstChild,t=o.offsetHeight,n=10,s=e.charCoords(Pos(0,7),"div").right;;s+=n)if(e.setSize(s),o.offsetHeight<2.5*t){if(10!=n)break;s-=10,n=1}e.setValue(e.getValue()+"\n\n");var a=e.charCoords(Pos(0,18),"local");is(a.top>.8*t,"not at top"),is(a.left>s-20,"not at right"),a=e.charCoords(Pos(0,18)),eqPos(e.coordsChar({left:a.left,top:a.top+5}),Pos(0,18))},{mode:"text/html",value:"\x3c!-- foo barrr --\x3e",lineWrapping:!0},ie_lt8||opera_lt10),testCM("scrollVerticallyAndHorizontally",function(e){e.setSize(100,100),addDoc(e,40,40),e.setCursor(39);var o=e.getWrapperElement(),t=byClassName(o,"CodeMirror-vscrollbar")[0],t=(is(t.offsetHeight<o.offsetHeight,"vertical scrollbar limited by horizontal one"),byClassName(o,"CodeMirror-cursor")[0].getBoundingClientRect()),o=o.getBoundingClientRect();is(t.bottom<o.top+e.getScrollerElement().clientHeight,"bottom line visible")},{lineNumbers:!0}),testCM("moveVstuck",function(e){var o=byClassName(e.getWrapperElement(),"CodeMirror-lines")[0].firstChild,t=o.offsetHeight,n="fooooooooooooooooooooooooo baaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaar\n";e.setValue(n);for(var s=2.8*e.charCoords(Pos(0,26),"div").right;e.setSize(s),!(o.offsetHeight<=3.5*t);s+=5);e.setCursor(Pos(0,n.length-1)),e.moveV(-1,"line"),eqPos(e.getCursor(),Pos(0,26))},{lineWrapping:!0},ie_lt8||opera_lt10),testCM("clickTab",function(e){var o=e.charCoords(Pos(0,0));eqPos(e.coordsChar({left:o.left+5,top:o.top+5}),Pos(0,0)),eqPos(e.coordsChar({left:o.right-5,top:o.top+5}),Pos(0,1))},{value:"\t\n\n",lineWrapping:!0,tabSize:8}),testCM("verticalScroll",function(e){e.setSize(100,200),e.setValue("foo\nbar\nbaz\n");var o=e.getScrollerElement(),t=o.scrollWidth,n=(e.setLine(0,"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah"),is(o.scrollWidth>t,"scrollbar present"),e.setLine(0,"foo"),phantom||eq(o.scrollWidth,t,"scrollbar gone"),e.setLine(0,"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah"),e.setLine(1,"bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbh"),is(o.scrollWidth>t,"present again"),o.scrollWidth);e.setLine(0,"foo"),is(o.scrollWidth<n,"scrollbar smaller"),is(o.scrollWidth>t,"but still present")}),testCM("extraKeys",function(a){var r;function e(e,o,t){var n={type:"keydown",keyCode:o="string"==typeof o?o.charCodeAt(0):o,preventDefault:function(){},stopPropagation:function(){}};if(t)for(var s in t)n[s]=t[s];r=null,a.triggerOnKeyDown(n),eq(r,e)}CodeMirror.commands.testCommand=function(){r="tc"},CodeMirror.commands.goTestCommand=function(){r="gtc"},a.setOption("extraKeys",{"Shift-X":function(){r="sx"},X:function(){r="x"},"Ctrl-Alt-U":function(){r="cau"},End:"testCommand",Home:"goTestCommand",Tab:!1}),e(null,"U"),e("cau","U",{ctrlKey:!0,altKey:!0}),e(null,"U",{shiftKey:!0,ctrlKey:!0,altKey:!0}),e("x","X"),e("sx","X",{shiftKey:!0}),e("tc",35),e(null,35,{shiftKey:!0}),e("gtc",36),e("gtc",36,{shiftKey:!0}),e(null,9)},null,window.opera&&mac),testCM("wordMovementCommands",function(e){e.execCommand("goWordLeft"),eqPos(e.getCursor(),Pos(0,0)),e.execCommand("goWordRight"),e.execCommand("goWordRight"),eqPos(e.getCursor(),Pos(0,7)),e.execCommand("goWordLeft"),eqPos(e.getCursor(),Pos(0,5)),e.execCommand("goWordRight"),e.execCommand("goWordRight"),eqPos(e.getCursor(),Pos(0,12)),e.execCommand("goWordLeft"),eqPos(e.getCursor(),Pos(0,9)),e.execCommand("goWordRight"),e.execCommand("goWordRight"),e.execCommand("goWordRight"),eqPos(e.getCursor(),Pos(0,24)),e.execCommand("goWordRight"),e.execCommand("goWordRight"),eqPos(e.getCursor(),Pos(1,9)),e.execCommand("goWordRight"),eqPos(e.getCursor(),Pos(1,13)),e.execCommand("goWordRight"),e.execCommand("goWordRight"),eqPos(e.getCursor(),Pos(2,0))},{value:"this is (the) firstline.\na foo12éø×bar\n"}),testCM("groupMovementCommands",function(e){e.execCommand("goGroupLeft"),eqPos(e.getCursor(),Pos(0,0)),e.execCommand("goGroupRight"),eqPos(e.getCursor(),Pos(0,4)),e.execCommand("goGroupRight"),eqPos(e.getCursor(),Pos(0,7)),e.execCommand("goGroupRight"),eqPos(e.getCursor(),Pos(0,10)),e.execCommand("goGroupLeft"),eqPos(e.getCursor(),Pos(0,7)),e.execCommand("goGroupRight"),e.execCommand("goGroupRight"),e.execCommand("goGroupRight"),eqPos(e.getCursor(),Pos(0,15)),e.setCursor(Pos(0,17)),e.execCommand("goGroupLeft"),eqPos(e.getCursor(),Pos(0,16)),e.execCommand("goGroupLeft"),eqPos(e.getCursor(),Pos(0,14)),e.execCommand("goGroupRight"),e.execCommand("goGroupRight"),eqPos(e.getCursor(),Pos(0,20)),e.execCommand("goGroupRight"),eqPos(e.getCursor(),Pos(1,5)),e.execCommand("goGroupLeft"),e.execCommand("goGroupLeft"),eqPos(e.getCursor(),Pos(1,0)),e.execCommand("goGroupLeft"),eqPos(e.getCursor(),Pos(0,16))},{value:"booo ba---quux. ffff\n  abc d"}),testCM("charMovementCommands",function(e){e.execCommand("goCharLeft"),e.execCommand("goColumnLeft"),eqPos(e.getCursor(),Pos(0,0)),e.execCommand("goCharRight"),e.execCommand("goCharRight"),eqPos(e.getCursor(),Pos(0,2)),e.setCursor(Pos(1,0)),e.execCommand("goColumnLeft"),eqPos(e.getCursor(),Pos(1,0)),e.execCommand("goCharLeft"),eqPos(e.getCursor(),Pos(0,5)),e.execCommand("goColumnRight"),eqPos(e.getCursor(),Pos(0,5)),e.execCommand("goCharRight"),eqPos(e.getCursor(),Pos(1,0)),e.execCommand("goLineEnd"),eqPos(e.getCursor(),Pos(1,5)),e.execCommand("goLineStartSmart"),eqPos(e.getCursor(),Pos(1,1)),e.execCommand("goLineStartSmart"),eqPos(e.getCursor(),Pos(1,0)),e.setCursor(Pos(2,0)),e.execCommand("goCharRight"),e.execCommand("goColumnRight"),eqPos(e.getCursor(),Pos(2,0))},{value:"line1\n ine2\n"}),testCM("verticalMovementCommands",function(e){e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(0,0)),e.execCommand("goLineDown"),phantom||eqPos(e.getCursor(),Pos(1,0)),e.setCursor(Pos(1,12)),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(2,5)),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(3,0)),e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(2,5)),e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(1,12)),e.execCommand("goPageDown"),eqPos(e.getCursor(),Pos(5,0)),e.execCommand("goPageDown"),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(5,0)),e.execCommand("goPageUp"),eqPos(e.getCursor(),Pos(0,0))},{value:"line1\nlong long line2\nline3\n\nline5\n"}),testCM("verticalMovementCommandsWrapping",function(e){e.setSize(120),e.setCursor(Pos(0,5)),e.execCommand("goLineDown"),eq(e.getCursor().line,0),is(5<e.getCursor().ch,"moved beyond wrap");for(var o=0;;++o){is(o<20,"no endless loop"),e.execCommand("goLineDown");var t=e.getCursor();if(1==t.line&&eq(t.ch,5),2==t.line){eq(t.ch,1);break}}},{value:"a very long line that wraps around somehow so that we can test cursor movement\nshortone\nk",lineWrapping:!0}),testCM("rtlMovement",function(r){forEach(["خحج","خحabcخحج","abخحخحجcd","abخde","abخح2342خ1حج","خ1ح2خح3حxج","خحcd","1خحcd","abcdeح1ج","خمرحبها مها!","foobarر",'<img src="/בדיקה3.jpg">'],function(e){for(var o="خ"==e.charAt(0),t=(r.setValue(e+"\n"),r.execCommand(o?"goLineEnd":"goLineStart"),byClassName(r.getWrapperElement(),"CodeMirror-cursor")[0]),n=t.offsetLeft,s=t.offsetTop,a=0;a<=e.length;++a)r.execCommand("goCharRight"),a==e.length?is(t.offsetTop>s,"next line"):is(t.offsetLeft>n,"moved right"),n=t.offsetLeft,s=t.offsetTop;r.setCursor(0,0),r.execCommand(o?"goLineStart":"goLineEnd");for(n=t.offsetLeft,a=0;a<e.length;++a)r.execCommand("goCharLeft"),is(t.offsetLeft<n,"moved left"),n=t.offsetLeft})},{rtlMoveVisually:!0}),testCM("bidiUpdate",function(e){e.setCursor(Pos(0,2)),e.replaceSelection("خحج","start"),e.execCommand("goCharRight"),eqPos(e.getCursor(),Pos(0,4))},{value:"abcd\n"}),testCM("movebyTextUnit",function(e){e.setValue("בְּרֵאשִ\ńéée\n"),e.execCommand("goLineEnd");for(var o=0;o<4;++o)e.execCommand("goCharRight");eqPos(e.getCursor(),Pos(0,0)),e.execCommand("goCharRight"),eqPos(e.getCursor(),Pos(1,0)),e.execCommand("goCharRight"),e.execCommand("goCharRight"),eqPos(e.getCursor(),Pos(1,3)),e.execCommand("goCharRight"),e.execCommand("goCharRight"),eqPos(e.getCursor(),Pos(1,6))}),testCM("lineChangeEvents",function(e){addDoc(e,3,5);for(var o=[],t=["ch 0","ch 1","del 2","ch 0","ch 0","del 1","del 3","del 4"],n=0;n<5;++n)CodeMirror.on(e.getLineHandle(n),"delete",function(e){return function(){o.push("del "+e)}}(n)),CodeMirror.on(e.getLineHandle(n),"change",function(e){return function(){o.push("ch "+e)}}(n));e.replaceRange("x",Pos(0,1)),e.replaceRange("xy",Pos(1,1),Pos(2)),e.replaceRange("foo\nbar",Pos(0,1)),e.replaceRange("",Pos(0,0),Pos(e.lineCount())),eq(o.length,t.length,"same length");for(n=0;n<o.length;++n)eq(o[n],t[n])}),testCM("scrollEntirelyToRight",function(e){var o;phantom||(addDoc(e,500,2),e.setCursor(Pos(0,500)),o=byClassName(e=e.getWrapperElement(),"CodeMirror-cursor")[0],is(e.getBoundingClientRect().right>o.getBoundingClientRect().left))}),testCM("lineWidgets",function(e){addDoc(e,500,3);var o=e.charCoords(Pos(2,0)),t=document.createElement("div");t.innerHTML="hi",e.addLineWidget(1,t);is(o.top<e.charCoords(Pos(2,0)).top,"took up space"),e.setCursor(Pos(1,1)),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(2,1)),e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(1,1))}),testCM("lineWidgetFocus",function(e){var o=document.getElementById("testground");o.className="offscreen";try{addDoc(e,500,10);var t=document.createElement("input");e.addLineWidget(1,t);t.focus(),eq(document.activeElement,t),e.replaceRange("new stuff",Pos(1,0)),eq(document.activeElement,t)}finally{o.className=""}}),testCM("getLineNumber",function(e){addDoc(e,2,20);var o=e.getLineHandle(1);eq(e.getLineNumber(o),1),e.replaceRange("hi\nbye\n",Pos(0,0)),eq(e.getLineNumber(o),3),e.setValue(""),eq(e.getLineNumber(o),null)}),testCM("jumpTheGap",function(e){var o="abcdef ghiklmnop qrstuvw xyz ",o=(e.setLine(2,o=(o=(o+="abcdef ghiklmnop qrstuvw xyz ")+o)+o),e.setSize("200px",null),e.getWrapperElement().style.lineHeight=2,e.refresh(),e.setCursor(Pos(0,1)),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(1,1)),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(2,1)),e.execCommand("goLineDown"),eq(e.getCursor().line,2),is(1<e.getCursor().ch),e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(2,1)),e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(1,1)),document.createElement("div"));o.innerHTML="hi",o.style.height="30px",e.addLineWidget(0,o),e.addLineWidget(1,o.cloneNode(!0),{above:!0}),e.setCursor(Pos(0,2)),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(1,2)),e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(0,2))},{lineWrapping:!0,value:"abc\ndef\nghi\njkl\n"}),testCM("addLineClass",function(s){function e(e,o,t,n){e=s.lineInfo(e);eq(e.textClass,o),eq(e.bgClass,t),eq(e.wrapClass,n)}s.addLineClass(0,"text","foo"),s.addLineClass(0,"text","bar"),s.addLineClass(1,"background","baz"),s.addLineClass(1,"wrap","foo"),e(0,"foo bar",null,null),e(1,null,"baz","foo");var o=s.display.lineDiv;eq(byClassName(o,"foo").length,2),eq(byClassName(o,"bar").length,1),eq(byClassName(o,"baz").length,1),s.removeLineClass(0,"text","foo"),e(0,"bar",null,null),s.removeLineClass(0,"text","foo"),e(0,"bar",null,null),s.removeLineClass(0,"text","bar"),e(0,null,null,null),s.addLineClass(1,"wrap","quux"),e(1,null,"baz","foo quux"),s.removeLineClass(1,"wrap"),e(1,null,"baz",null)},{value:"hohoho\n"}),testCM("atomicMarker",function(r){function e(e,o,t,n,s,a){return r.markText(Pos(e,o),Pos(t,n),{atomic:!0,inclusiveLeft:s,inclusiveRight:a})}addDoc(r,10,10);var o=e(0,1,0,5);r.setCursor(Pos(0,1)),r.execCommand("goCharRight"),eqPos(r.getCursor(),Pos(0,5)),r.execCommand("goCharLeft"),eqPos(r.getCursor(),Pos(0,1)),o.clear(),o=e(0,0,0,5,!0),eqPos(r.getCursor(),Pos(0,5),"pushed out"),r.execCommand("goCharLeft"),eqPos(r.getCursor(),Pos(0,5)),o.clear(),o=e(8,4,9,10,!1,!0),r.setCursor(Pos(9,8)),eqPos(r.getCursor(),Pos(8,4),"set"),r.execCommand("goCharRight"),eqPos(r.getCursor(),Pos(8,4),"char right"),r.execCommand("goLineDown"),eqPos(r.getCursor(),Pos(8,4),"line down"),r.execCommand("goCharLeft"),eqPos(r.getCursor(),Pos(8,3)),o.clear(),o=e(1,1,3,8),r.setCursor(Pos(2,0)),eqPos(r.getCursor(),Pos(3,8)),r.execCommand("goCharLeft"),eqPos(r.getCursor(),Pos(1,1)),r.execCommand("goCharRight"),eqPos(r.getCursor(),Pos(3,8)),r.execCommand("goLineUp"),eqPos(r.getCursor(),Pos(1,1)),r.execCommand("goLineDown"),eqPos(r.getCursor(),Pos(3,8)),r.execCommand("delCharBefore"),eq(r.getValue().length,80,"del chunk"),o=e(3,0,5,5),r.setCursor(Pos(3,0)),r.execCommand("delWordAfter"),eq(r.getValue().length,53,"del chunk")}),testCM("readOnlyMarker",function(a){function e(e,o,t,n,s){return a.markText(Pos(e,o),Pos(t,n),{readOnly:!0,atomic:s})}var o=e(0,1,0,4);a.setCursor(Pos(0,2)),a.replaceSelection("hi","end"),eqPos(a.getCursor(),Pos(0,2)),eq(a.getLine(0),"abcde"),a.execCommand("selectAll"),a.replaceSelection("oops"),eq(a.getValue(),"oopsbcd"),a.undo(),eqPos(o.find().from,Pos(0,1)),eqPos(o.find().to,Pos(0,4)),o.clear(),a.setCursor(Pos(0,2)),a.replaceSelection("hi"),eq(a.getLine(0),"abhicde"),eqPos(a.getCursor(),Pos(0,4)),o=e(0,2,2,2,!0),a.setSelection(Pos(1,1),Pos(2,4)),a.replaceSelection("t","end"),eqPos(a.getCursor(),Pos(2,3)),eq(a.getLine(2),"klto"),a.execCommand("goCharLeft"),a.execCommand("goCharLeft"),eqPos(a.getCursor(),Pos(0,2)),a.setSelection(Pos(0,1),Pos(0,3)),a.replaceSelection("xx"),eqPos(a.getCursor(),Pos(0,3)),eq(a.getLine(0),"axxhicde")},{value:"abcde\nfghij\nklmno\n"}),testCM("dirtyBit",function(e){eq(e.isClean(),!0),e.replaceSelection("boo"),eq(e.isClean(),!1),e.undo(),eq(e.isClean(),!0),e.replaceSelection("boo"),e.replaceSelection("baz"),e.undo(),eq(e.isClean(),!1),e.markClean(),eq(e.isClean(),!0),e.undo(),eq(e.isClean(),!1),e.redo(),eq(e.isClean(),!0)}),testCM("addKeyMap",function(o){function e(e){o.triggerOnKeyDown({type:"keydown",keyCode:e,preventDefault:function(){},stopPropagation:function(){}})}e(39),eqPos(o.getCursor(),Pos(0,1));var t=0,n={Right:function(){++t}},s={Right:function(){t+=10}};o.addKeyMap(n),e(39),eqPos(o.getCursor(),Pos(0,1)),eq(t,1),o.addKeyMap(s,!0),e(39),eq(t,2),o.removeKeyMap(n),e(39),eq(t,12),o.removeKeyMap(s),e(39),eq(t,12),eqPos(o.getCursor(),Pos(0,2)),o.addKeyMap({Right:function(){t=55},name:"mymap"}),e(39),eq(t,55),o.removeKeyMap("mymap"),e(39),eqPos(o.getCursor(),Pos(0,3))},{value:"abc"}),testCM("findPosH",function(t){forEach([{from:Pos(0,0),to:Pos(0,1),by:1},{from:Pos(0,0),to:Pos(0,0),by:-1,hitSide:!0},{from:Pos(0,0),to:Pos(0,4),by:1,unit:"word"},{from:Pos(0,0),to:Pos(0,8),by:2,unit:"word"},{from:Pos(0,0),to:Pos(2,0),by:20,unit:"word",hitSide:!0},{from:Pos(0,7),to:Pos(0,5),by:-1,unit:"word"},{from:Pos(0,4),to:Pos(0,8),by:1,unit:"word"},{from:Pos(1,0),to:Pos(1,18),by:3,unit:"word"},{from:Pos(1,22),to:Pos(1,5),by:-3,unit:"word"},{from:Pos(1,15),to:Pos(1,10),by:-5},{from:Pos(1,15),to:Pos(1,10),by:-5,unit:"column"},{from:Pos(1,15),to:Pos(1,0),by:-50,unit:"column",hitSide:!0},{from:Pos(1,15),to:Pos(1,24),by:50,unit:"column",hitSide:!0},{from:Pos(1,15),to:Pos(2,0),by:50,hitSide:!0}],function(e){var o=t.findPosH(e.from,e.by,e.unit||"char");eqPos(o,e.to),eq(!!o.hitSide,!!e.hitSide)})},{value:"line one\nline two.something.other\n"}),testCM("beforeChange",function(e){e.on("beforeChange",function(e,o){for(var t=[],n=0;n<o.text.length;++n)t.push(o.text[n].replace(/\s/g,"_"));o.update(null,null,t)}),e.setValue("hello, i am a\nnew document\n"),eq(e.getValue(),"hello,_i_am_a\nnew_document\n"),CodeMirror.on(e.getDoc(),"beforeChange",function(e,o){0==o.from.line&&o.cancel()}),e.setValue("oops"),eq(e.getValue(),"hello,_i_am_a\nnew_document\n"),e.replaceRange("hey hey hey",Pos(1,0),Pos(2,0)),eq(e.getValue(),"hello,_i_am_a\nhey_hey_hey")},{value:"abcdefghijk"}),testCM("beforeChangeUndo",function(e){e.setLine(0,"hi"),e.setLine(0,"bye"),eq(e.historySize().undo,2),e.on("beforeChange",function(e,o){is(!o.update),o.cancel()}),e.undo(),eq(e.historySize().undo,0),eq(e.getValue(),"bye\ntwo")},{value:"one\ntwo"}),testCM("beforeSelectionChange",function(e){function t(e,o){e=e.getLine(o.line).length;return e&&o.ch!=e?o:Pos(o.line,o.ch-1)}e.on("beforeSelectionChange",function(e,o){o.head=t(e,o.head),o.anchor=t(e,o.anchor)}),addDoc(e,10,10),e.execCommand("goLineEnd"),eqPos(e.getCursor(),Pos(0,9)),e.execCommand("selectAll"),eqPos(e.getCursor("start"),Pos(0,0)),eqPos(e.getCursor("end"),Pos(9,9))}),testCM("change_removedText",function(e){var t;e.setValue("abc\ndef"),e.on("change",function(e,o){t=[o.removed,o.next&&o.next.removed]}),e.operation(function(){e.replaceRange("xyz",Pos(0,0),Pos(1,1)),e.replaceRange("123",Pos(0,0))}),eq(t[0].join("\n"),"abc\nd"),eq(t[1].join("\n"),""),e.undo(),eq(t[0].join("\n"),"123"),eq(t[1].join("\n"),"xyz"),e.redo(),eq(t[0].join("\n"),"abc\nd"),eq(t[1].join("\n"),"")});
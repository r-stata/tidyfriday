var topojson=require("topojson"),toGeoJSON=require("togeojson"),gtfs2geojson=require("gtfs2geojson"),csv2geojson=require("csv2geojson"),osmtogeojson=require("osmtogeojson"),polytogeojson=require("polytogeojson"),geojsonNormalize=require("geojson-normalize");function readDrop(l){return function(){var r=[],n=[];if(!(d3.event.dataTransfer&&d3.event.dataTransfer&&d3.event.dataTransfer.files&&d3.event.dataTransfer.files.length))return l({message:"No files were dropped"});d3.event.stopPropagation(),d3.event.preventDefault();var s=d3.event.dataTransfer.files.length;function a(e,o,t){if(!o.length&&e.length)return l(e[0],null,t);l(null,{type:"FeatureCollection",features:o.reduce(function(e,o){return e=(o=geojsonNormalize(o))?e.concat(o.features):e},[])},t)}[].forEach.call(d3.event.dataTransfer.files,function(t){readAsText(t,function(e,o){e?(n.push(e),--s||a(n,r)):readFile(t,o,function(e,o,t){e&&n.push(e),o&&r.push(o),t&&r.push(t),--s||a(n,r,t)})})})}}function readAsText(e,o){try{var t=new FileReader;t.readAsText(e),t.onload=function(e){e.target&&e.target.result?o(null,e.target.result):o({message:"Dropped file could not be loaded"})},t.onerror=function(e){o({message:"Dropped file was unreadable"})}}catch(e){o({message:"Dropped file was unreadable"})}}function readFile(e,t,r){var o=function(e,o){var t=e.name?e.name.toLowerCase():"";function r(e){return-1!==t.indexOf(e)}if("application/vnd.google-earth.kml+xml"===e.type||r(".kml"))return"kml";if(r(".gpx"))return"gpx";if(r(".geojson")||r(".json")||r(".topojson"))return"geojson";if("text/csv"===e.type||r(".csv")||r(".tsv")||r(".dsv"))return"dsv";if(r(".xml")||r(".osm"))return"xml";if(r(".poly"))return"poly";if(o&&-1!=o.indexOf("shape_id,shape_pt_lat,shape_pt_lon"))return"gtfs"}(e,t);if(!o)return(e.name?e.name.toLowerCase():"").split("."),r({message:"Could not detect file type"});if("kml"===o){e=u(t);if(!e)return r({message:"Invalid KML file: not valid XML"});e.getElementsByTagName("NetworkLink").length&&(n={message:"The KML file you uploaded included NetworkLinks: some content may not display. Please export and upload KML without NetworkLinks for optimal performance"}),r(null,toGeoJSON.kml(e),n)}else if("xml"===o){var n,e=u(t);if(!e)return r({message:"Invalid XML file: not valid XML"});(n=osmtogeojson.toGeojson(e)).features.forEach(function(e){e.properties=e.properties.tags}),r(null,n)}else if("gpx"===o)r(null,toGeoJSON.gpx(u(t)));else if("geojson"===o)try{var s=JSON.parse(t);if(s&&"Topology"===s.type&&s.objects){var a,l={type:"FeatureCollection",features:[]};for(a in s.objects){var i=topojson.feature(s,s.objects[a]);i.features?l.features=l.features.concat(i.features):l.features=l.features.concat([i])}return r(null,l)}return r(null,s)}catch(e){alert("Invalid JSON file: "+e)}else if("dsv"===o)csv2geojson.csv2geojson(t,{delimiter:"auto"},function(e,o){return e?r({type:"geocode",result:o,raw:t}):r(null,o)});else if("gtfs"===o)try{return r(null,gtfs2geojson(t))}catch(e){return r({message:"Invalid GTFS file"})}else"poly"===o&&r(null,polytogeojson(t));function u(e){return(new DOMParser).parseFromString(e,"text/xml")}}module.exports.readDrop=readDrop,module.exports.readAsText=readAsText,module.exports.readFile=readFile;
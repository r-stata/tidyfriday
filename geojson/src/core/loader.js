var qs=require("qs-hash"),zoomextent=require("../lib/zoomextent"),flash=require("../ui/flash");module.exports=function(o){function r(e,a){o.container.select(".map").classed("loading",!1);var t;if(e){try{t=e.message||JSON.parse(e.responseText).message.replace(/(http:\/\/\S*)/g,'<a href="$&">$&</a>')}catch(e){t="Sorry, an error occurred."}return flash(o.container,t)}o.data.parse(a),qs.stringQs(location.hash.substring(1)).map&&2!=o.map.getZoom()&&!o.map.getCenter().equals(new L.LatLng(20,0))||zoomextent(o)}function s(e){d3.json(e).header("Accept","application/vnd.geo+json").on("load",function(e){o.data.set({map:e}),location.hash="",zoomextent(o)}).on("error",function(){return flash(o.container,"Could not load external file. External files must be served with CORS and be valid GeoJSON.")}).get()}return function(e){if(e.id||e.data){var a=d3.event?qs.stringQs(d3.event.oldURL.split("#")[1]).id:o.data.get("route");if(e.data){var t=e.data.match(/^(data\:[\w\-]+\/[\w\-]+\,?)/);if(t)if("data:application/json,"==t[0]){var n=e.data.replace(t[0],"");try{o.data.set({map:JSON.parse(n)}),location.hash="",zoomextent(o)}catch(e){return void flash(o.container,"Could not parse JSON")}}else"data:text/x-url,"==t[0]&&s(e.data.replace(t[0],""))}else e.id!==a&&(o.container.select(".map").classed("loading",!0),o.data.fetch(e,r))}}};
var config=require("../config.js")(location.hostname);module.exports=function(o){var e,n={};return n.details=function(t){if(!o.storage.get("github_token"))return t(new Error("not logged in"));var e=o.storage.get("github_user_details");e&&e.when>+new Date-36e5?t(null,e.data):(o.storage.remove("github_user_details"),e=config.GithubAPI?config.GithubAPI+"/api/v3":"https://api.github.com",d3.json(e+"/user").header("Authorization","token "+o.storage.get("github_token")).on("load",function(e){o.storage.set("github_user_details",{when:+new Date,data:e}),o.storage.set("github_user",e),t(null,e)}).on("error",function(){n.logout(),o.storage.remove("github_user_details"),t(new Error("not logged in"))}).get())},n.signXHR=function(e){return n.token()?e.header("Authorization","token "+n.token()):e},n.authenticate=function(){window.location.href=(config.GithubAPI||"https://github.com")+"/login/oauth/authorize?client_id="+config.client_id+"&scope=gist,repo"},n.token=function(e){return o.storage.get("github_token")},n.logout=function(){o.storage.remove("github_token")},n.login=function(){o.storage.remove("github_token")},window.location.search&&0===window.location.search.indexOf("?code")&&(e=window.location.search.replace(/\?{0,1}code=([^\#\&]+).*$/g,"$1"),d3.select(".map").classed("loading",!0),d3.json(config.gatekeeper_url+"/authenticate/"+e).on("load",function(e){d3.select(".map").classed("loading",!1),e.token&&(window.localStorage.github_token=e.token),-1!==window.location.href.indexOf("?code")&&(window.location.href=window.location.href.replace(/\?code=.*$/,""))}).on("error",function(){d3.select(".map").classed("loading",!1),alert("Authentication with GitHub failed")}).get()),n};
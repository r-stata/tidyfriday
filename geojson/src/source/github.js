module.exports.save=save,module.exports.load=load,module.exports.loadRaw=loadRaw;var config=require("../config.js")(location.hostname),githubBase=config.GithubAPI?config.GithubAPI+"/api/v3":"https://api.github.com";function save(s,i){var u=s.data.get("source"),l=s.data.get("meta"),c=s.data.get("newpath"),g=l&&l.name||"map.geojson",p=s.data.get("map");return-1===navigator.appVersion.indexOf("MSIE 9")&&window.XMLHttpRequest?localStorage.github_token?void s.repo.details(function(e,n){var o,t="POST",r={};if(!e&&n.permissions.push){if(!(e=s.commitMessage||prompt("Commit message:")))return;o=u.url,t="PUT";var a={message:e,branch:l.branch,content:btoa(encodeURIComponent(JSON.stringify(p,null,2)).replace(/%([0-9A-F]{2})/g,function(e,n){return String.fromCharCode("0x"+n)}))};c&&(a.path=c,s.data.set({newpath:null})),u.sha&&(a.sha=u.sha)}else o=githubBase+"/gists",r[g]={content:JSON.stringify(p,null,2)},a={files:r};s.user.signXHR(d3.json(o)).on("load",function(e){i(null,e)}).on("error",function(e){var n;try{n=JSON.parse(e.responseText).message.replace(/(http:\/\/\S*)/g,'<a href="$&">$&</a>')}catch(e){n="Sorry, an error occurred."}i(n)}).send(t,JSON.stringify(a))}):alert("You need to log in with GitHub to commit changes"):alert("Sorry, saving and sharing is not supported in IE9 and lower. Please use a modern browser to enjoy the full featureset of geojson.io")}function parseGitHubId(e){e=e.split("/");return{user:e[0],repo:e[1],mode:e[2],branch:e[3],file:e.slice(4).join("/")}}function load(e,n,o){n.user.signXHR(d3.json(fileUrl(e))).on("load",function(e){o(null,e)}).on("error",function(e){o(e,null)}).get()}function loadRaw(e,n,o,t){o.user.signXHR(d3.text(shaUrl(e,n))).on("load",function(e){t(null,e)}).on("error",function(e){t(e,null)}).header("Accept","application/vnd.github.raw").get()}function fileUrl(e){return githubBase+"/repos/"+e.user+"/"+e.repo+"/contents/"+e.path+"?ref="+e.branch}function shaUrl(e,n){return githubBase+"/repos/"+e.user+"/"+e.repo+"/git/blobs/"+n}
var validate=require("../lib/validate"),zoomextent=require("../lib/zoomextent"),saver=require("../ui/saver.js");module.exports=function(a){function e(){return saver(a),!1}function t(e){var e=e.html("").append("textarea"),t=CodeMirror.fromTextArea(e.node(),{mode:"application/json",matchBrackets:!0,tabSize:2,gutters:["error"],theme:"eclipse",autofocus:window===window.top,keyMap:"tabSpace",lineNumbers:!0});t.on("change",validate(function(e,t,n){e||(a.data.set({map:t},"json"),n&&zoomextent(a))})),a.dispatch.on("change.json",function(e){"json"!==e.source&&(e=t.getScrollInfo(),t.setValue(JSON.stringify(a.data.get("map"),null,2)),t.scrollTo(e.left,e.top))}),t.setValue(JSON.stringify(a.data.get("map"),null,2))}return CodeMirror.keyMap.tabSpace={Tab:function(e){var t=new Array(e.getOption("indentUnit")+1).join(" ");e.replaceSelection(t,"end","+input")},"Ctrl-S":e,"Cmd-S":e,fallthrough:["default"]},t.off=function(){a.dispatch.on("change.json",null)},t};
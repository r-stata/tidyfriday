var shpwrite=require("shp-write"),clone=require("clone"),geojson2dsv=require("geojson2dsv"),topojson=require("topojson"),saveAs=require("filesaver.js"),tokml=require("tokml"),githubBrowser=require("@mapbox/github-file-browser"),gistBrowser=require("@mapbox/gist-map-browser"),geojsonNormalize=require("geojson-normalize"),wellknown=require("wellknown"),share=require("./share"),modal=require("./modal.js"),flash=require("./flash"),zoomextent=require("../lib/zoomextent"),readFile=require("../lib/readfile"),meta=require("../lib/meta.js"),saver=require("../ui/saver.js"),config=require("../config.js")(location.hostname);module.exports=function(s){var t="undefined"!=typeof ArrayBuffer,c=/a\.tiles\.mapbox.com/.test(L.mapbox.config.HTTP_URL),d=!!config.GithubAPI,u=d?config.GithubAPI+"/api/v3":"https://api.github.com",p=[{title:"GeoJSON",action:function(){d3.event&&d3.event.preventDefault();var t=JSON.stringify(s.data.get("map")),e=s.data.get("meta");saveAs(new Blob([t],{type:"text/plain;charset=utf-8"}),e&&e.name||"map.geojson")}},{title:"TopoJSON",action:function(){var t=JSON.stringify(topojson.topology({collection:clone(s.data.get("map"))},{"property-transform":e}));saveAs(new Blob([t],{type:"text/plain;charset=utf-8"}),"map.topojson")}},{title:"CSV",action:function(){d3.event&&d3.event.preventDefault();var t=geojson2dsv(s.data.get("map"));saveAs(new Blob([t],{type:"text/plain;charset=utf-8"}),"points.csv")}},{title:"KML",action:function(){d3.event&&d3.event.preventDefault();var t=tokml(s.data.get("map"));s.data.get("meta");saveAs(new Blob([t],{type:"text/plain;charset=utf-8"}),"map.kml")}},{title:"WKT",action:function(){d3.event&&d3.event.preventDefault();var t=s.data.get("map").features;0!==t.length&&(t=t.map(wellknown.stringify).join("\n"),s.data.get("meta"),saveAs(new Blob([t],{type:"text/plain;charset=utf-8"}),"map.wkt"))}}];function e(t,e,a){return t[e]=a,!0}return t&&p.push({title:"Shapefile",action:function(){d3.event&&d3.event.preventDefault();d3.select(".map").classed("loading",!0);try{shpwrite.download(s.data.get("map"))}finally{d3.select(".map").classed("loading",!1)}}}),function(t){var n,o,e=[{title:"Save",action:c||d?a:function(){},children:p},{title:"New",action:function(){window.open(window.location.origin+window.location.pathname+"#new")}},{title:"Meta",action:function(){},children:[{title:"Add map layer",alt:"Add a custom tile layer",action:function(){var t,e=prompt("Layer URL \n(http://tile.stamen.com/watercolor/{z}/{x}/{y}.jpg)");null!==e&&null!==(t=prompt("Layer name"))&&meta.adduserlayer(s,e,t)}},{title:"Zoom to features",alt:"Zoom to the extent of all features",action:function(){meta.zoomextent(s)}},{title:"Clear",alt:"Delete all features from the map",action:function(){confirm("Are you sure you want to delete all features from this map?")&&meta.clear(s)}},{title:"Random: Points",alt:"Add random points to your map",action:function(){var t=prompt("Number of points (default: 100)");null!==t&&(t=parseInt(t,10),isNaN(t)&&(t=100),meta.random(s,t,"point"))}},{title:"Add bboxes",alt:"Add bounding box members to all applicable GeoJSON objects",action:function(){meta.bboxify(s)}},{title:"Flatten Multi Features",alt:"Flatten MultiPolygons, MultiLines, and GeometryCollections into simple geometries",action:function(){meta.flatten(s)}},{title:"Load encoded polyline",alt:"Decode and show an encoded polyline. Precision 5 is supported.",action:function(){meta.polyline(s)}},{title:"Load WKB Base64 Encoded String",alt:"Decode and show WKX data",action:function(){meta.wkxBase64(s)}},{title:"Load WKB Hex Encoded String",alt:"Decode and show WKX data",action:function(){meta.wkxHex(s)}},{title:"Load WKT String",alt:"Decode and show WKX data",action:function(){meta.wkxString(s)}}]}];c||d?(e.unshift({title:"Open",children:[{title:"File",alt:"GeoJSON, TopoJSON, GTFS, KML, CSV, GPX and OSM XML supported",action:l},{title:"GitHub",alt:"GeoJSON files in GitHub Repositories",authenticated:!0,action:function(){if(!s.user.token())return flash(s.container,"You must authenticate to use this API.");var n=modal(d3.select("div.geojsonio"));n.select(".m").attr("class","modal-splash modal col6"),n.select(".content").append("div").attr("class","header pad2 fillD").append("h1").text("GitHub"),githubBrowser(s.user.token(),!1,u).open().onclick(function(a){if(a&&a.length){var t=a[a.length-1];if(!t.path)throw new Error("last is invalid: "+JSON.stringify(t));if(!t.path.match(/\.(geo)?json/i))return alert("only GeoJSON files are supported from GitHub");"blob"===t.type&&githubBrowser.request("/repos/"+a[1].full_name+"/git/blobs/"+t.sha,function(t,e){a.content=JSON.parse(decodeURIComponent(Array.prototype.map.call(atob(e[0].content),function(t){return"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)}).join(""))),s.data.parse(a),zoomextent(s),n.close()})}}).appendTo(n.select(".content").append("div").attr("class","repos pad2").node())}},{title:"Gist",alt:"GeoJSON files in GitHub Gists",authenticated:!0,action:function(){if(!s.user.token())return flash(s.container,"You must authenticate to use this API.");var e=modal(d3.select("div.geojsonio"));e.select(".m").attr("class","modal-splash modal col6"),gistBrowser(s.user.token(),u).open().onclick(function(t){s.data.parse(t),zoomextent(s),e.close()}).appendTo(e.select(".content").append("div").attr("class","repos pad2").node())}}]}),e[1].children.unshift({title:"GitHub",alt:"GeoJSON files in GitHub Repositories",authenticated:!0,action:function(){if(!s.user.token())return flash(s.container,"You must authenticate to use this API.");var i=modal(d3.select("div.geojsonio"));i.select(".m").attr("class","modal-splash modal col6"),i.select(".content").append("div").attr("class","header pad2 fillD").append("h1").text("GitHub"),githubBrowser(s.user.token(),!0,u).open().onclick(function(t){var e,a,n,o;t&&t.length&&("new"===(e=t[t.length-1]).type?(o=prompt("New file name"))?((a=t.slice(3)).pop(),a.push({path:o}),n=a.map(function(t){return t.path}).join("/"),s.data.set({source:{url:u+"/repos/"+t[0].login+"/"+t[1].name+"/contents/"+n+"?ref="+t[2].name},type:"github",meta:{branch:t[2].name,login:t[0].login,repo:t[1].name}}),s.data.set({newpath:n+o}),i.close(),saver(s)):i.close():"blob"===e.type&&(n=(a=t.slice(3)).map(function(t){return t.path}).join("/"),s.data.set({source:{url:u+"/repos/"+t[0].login+"/"+t[1].name+"/contents/"+n+"?ref="+t[2].name,sha:e.sha},type:"github",meta:{branch:t[2].name,login:t[0].login,repo:t[1].name}}),i.close(),saver(s)))}).appendTo(i.select(".content").append("div").attr("class","repos pad2").node())}},{title:"Gist",alt:"GeoJSON files in GitHub Gists",authenticated:!0,action:function(){d3.event&&d3.event.preventDefault();s.data.set({type:"gist"}),saver(s)}}),c&&e.splice(3,0,{title:"Share",action:function(){s.container.call(share(s))}})):e.unshift({title:"Open",alt:"CSV, GTFS, KML, GPX, and other filetypes",action:l});var i=(e=t.append("div").attr("class","inline").selectAll("div.item").data(e).enter().append("div").attr("class","item")).append("a").attr("class","parent").on("click",function(t){t.action&&t.action.apply(this,t)}).text(function(t){return" "+t.title}),e=(e.each(function(t){var e;t.children&&d3.select(this).append("div").attr("class","children").call((e=t.children,function(t){t.selectAll("a").data(e).enter().append("a").attr("title",function(t){if("File"==t.title||"GitHub"==t.title||"Gist"==t.title||"Add map layer"==t.title||"Zoom to features"==t.title||"Clear"==t.title||"Random: Points"==t.title||"Add bboxes"==t.title||"Flatten Multi Features"==t.title)return t.alt}).text(function(t){return t.title}).on("click",function(t){t.action.apply(this,t)})}))}),t.append("div").attr("class","name"));function a(){d3.event&&d3.event.preventDefault(),saver(s)}function l(){var t=d3.select("body").append("input").attr("type","file").style("visibility","hidden").style("position","absolute").style("height","0").on("change",function(){var a=this.files;a&&a[0]&&(readFile.readAsText(a[0],function(t,e){readFile.readFile(a[0],e,r),a[0].path&&s.data.set({path:a[0].path})}),t.remove())});t.node().click()}function r(t,e,a){(e=geojsonNormalize(e))&&(s.data.mergeFeatures(e.features),a?flash(s.container,a.message):flash(s.container,"Imported "+e.features.length+" features.").classed("success","true"),zoomextent(s))}(c||d)&&(n=e.append("a").attr("target","_blank").attr("class","icon-file-alt"),o=e.append("span").attr("class","filename").text("unsaved")),s.dispatch.on("change.filebar",function(t){var t=t.obj,e=t.type,a=t.path;(c||d)&&o.text(a||"unsaved").classed("deemphasize",s.data.dirty);(c||d)&&n.attr("href",t.url).attr("class",function(t){return"github"==t?"icon-github":"gist"==t?"icon-github-alt":"icon-file-alt"}(e));!function(t){i.filter(function(t){return"Save"===t.title}).select("span.title").text(t)}("github"==e?"Commit":"Save")}),d3.select(document).call(d3.keybinding("file_bar").on("⌘+o",function(){l(),d3.event.preventDefault()}).on("⌘+s",a))}};
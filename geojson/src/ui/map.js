require("qs-hash"),require("../lib/custom_hash.js");for(var popup=require("../lib/popup"),escape=require("escape-html"),LGeo=require("leaflet-geodesy"),geojsonRewind=require("geojson-rewind"),writable=!1,showStyle=!0,makiValues=require("../../data/maki.json"),maki="",i=0;i<makiValues.length;i++)maki+='<option value="'+makiValues[i].icon+'">';function geojsonToLayer(t,e){e.clearLayers(),L.geoJson(t,{style:L.mapbox.simplestyle.style,pointToLayer:function(t,e){return t.properties||(t.properties={}),L.mapbox.marker.style(t,e)}}).eachLayer(function(t){bindPopup(t),t.addTo(e)})}function bindPopup(t){var e,a=JSON.parse(JSON.stringify(t.toGeoJSON().properties)),r="",o="",l={};for(e in a){var i=escape(e);"object"==typeof a[e]?l[i]=escape(JSON.stringify(a[e])):l[i]=escape(a[e])}if(l){for(var n in Object.keys(l).length||(l={"":""}),t.feature&&t.feature.geometry&&writable&&("Point"!==t.feature.geometry.type&&"MultiPoint"!==t.feature.geometry.type||("marker-color"in l||(r+='<tr class="style-row"><th><input type="text" value="marker-color"'+(writable?"":" readonly")+' /></th><td><input type="color" value="#7E7E7E"'+(writable?"":" readonly")+" /></td></tr>"),"marker-size"in l||(r+='<tr class="style-row"><th><input type="text" value="marker-size"'+(writable?"":" readonly")+' /></th><td><input type="text" list="marker-size" value="medium"'+(writable?"":" readonly")+' /><datalist id="marker-size"><option value="small"><option value="medium"><option value="large"></datalist></td></tr>'),"marker-symbol"in l||(r+='<tr class="style-row"><th><input type="text" value="marker-symbol"'+(writable?"":" readonly")+' /></th><td><input type="text" list="marker-symbol" value=""'+(writable?"":" readonly")+' /><datalist id="marker-symbol">'+maki+"</datalist></td></tr>")),"LineString"!==t.feature.geometry.type&&"MultiLineString"!==t.feature.geometry.type&&"Polygon"!==t.feature.geometry.type&&"MultiPolygon"!==t.feature.geometry.type||("stroke"in l||(r+='<tr class="style-row"><th><input type="text" value="stroke"'+(writable?"":" readonly")+' /></th><td><input type="color" value="#555555"'+(writable?"":" readonly")+" /></td></tr>"),"stroke-width"in l||(r+='<tr class="style-row"><th><input type="text" value="stroke-width"'+(writable?"":" readonly")+' /></th><td><input type="number" min="0" step="0.1" value="2"'+(writable?"":" readonly")+" /></td></tr>"),"stroke-opacity"in l||(r+='<tr class="style-row"><th><input type="text" value="stroke-opacity"'+(writable?"":" readonly")+' /></th><td><input type="number" min="0" max="1" step="0.1" value="1"'+(writable?"":" readonly")+" /></td></tr>")),"Polygon"!==t.feature.geometry.type&&"MultiPolygon"!==t.feature.geometry.type||("fill"in l||(r+='<tr class="style-row"><th><input type="text" value="fill"'+(writable?"":" readonly")+' /></th><td><input type="color" value="#555555"'+(writable?"":" readonly")+" /></td></tr>"),"fill-opacity"in l||(r+='<tr class="style-row"><th><input type="text" value="fill-opacity"'+(writable?"":" readonly")+' /></th><td><input type="number" min="0" max="1" step="0.1" value="0.5"'+(writable?"":" readonly")+" /></td></tr>"))),l)r+="marker-color"!=n&&"stroke"!=n&&"fill"!=n||!writable?"marker-size"==n&&writable?'<tr class="style-row"><th><input type="text" value="'+n+'"'+(writable?"":" readonly")+' /></th><td><input type="text" list="marker-size" value="'+l[n]+'"'+(writable?"":" readonly")+' /><datalist id="marker-size"><option value="small"><option value="medium"><option value="large"></datalist></td></tr>':"marker-symbol"==n&&writable?'<tr class="style-row"><th><input type="text" value="'+n+'"'+(writable?"":" readonly")+' /></th><td><input type="text" list="marker-symbol" value="'+l[n]+'"'+(writable?"":" readonly")+' /><datalist id="marker-symbol">'+maki+"</datalist></td></tr>":"stroke-width"==n&&writable?'<tr class="style-row"><th><input type="text" value="'+n+'"'+(writable?"":" readonly")+' /></th><td><input type="number" min="0" step="0.1" value="'+l[n]+'"'+(writable?"":" readonly")+" /></td></tr>":"stroke-opacity"!=n&&"fill-opacity"!=n||!writable?'<tr><th><input type="text" value="'+n+'"'+(writable?"":" readonly")+' /></th><td><input type="text" value="'+l[n]+'"'+(writable?"":" readonly")+" /></td></tr>":'<tr class="style-row"><th><input type="text" value="'+n+'"'+(writable?"":" readonly")+' /></th><td><input type="number" min="0" max="1" step="0.1" value="'+l[n]+'"'+(writable?"":" readonly")+" /></td></tr>":'<tr class="style-row"><th><input type="text" value="'+n+'"'+(writable?"":" readonly")+' /></th><td><input type="color" value="'+l[n]+'"'+(writable?"":" readonly")+" /></td></tr>";t.feature&&t.feature.geometry&&(o+='<table class="metadata">',"LineString"===t.feature.geometry.type?o+="<tr><td>Meters</td><td>"+(s=d3.pairs(t.feature.geometry.coordinates).reduce(function(t,e){return t+L.latLng(e[0][1],e[0][0]).distanceTo(L.latLng(e[1][1],e[1][0]))},0)).toFixed(2)+"</td></tr><tr><td>Kilometers</td><td>"+(s/1e3).toFixed(2)+"</td></tr><tr><td>Feet</td><td>"+(s/.3048).toFixed(2)+"</td></tr><tr><td>Yards</td><td>"+(s/.9144).toFixed(2)+"</td></tr><tr><td>Miles</td><td>"+(s/1609.34).toFixed(2)+"</td></tr>":"Point"===t.feature.geometry.type?o+="<tr><td>Latitude </td><td>"+t.feature.geometry.coordinates[1].toFixed(4)+"</td></tr><tr><td>Longitude</td><td>"+t.feature.geometry.coordinates[0].toFixed(4)+"</td></tr>":"Polygon"===t.feature.geometry.type&&(o+="<tr><td>Sq. Meters</td><td>"+LGeo.area(t).toFixed(2)+"</td></tr><tr><td>Sq. Kilometers</td><td>"+(LGeo.area(t)/1e6).toFixed(2)+"</td></tr><tr><td>Sq. Feet</td><td>"+(LGeo.area(t)/.092903).toFixed(2)+"</td></tr><tr><td>Acres</td><td>"+(LGeo.area(t)/4046.86).toFixed(2)+"</td></tr><tr><td>Sq. Miles</td><td>"+(LGeo.area(t)/2589990).toFixed(2)+"</td></tr>"),o+="</table>");var s='<div class="pad1 tabs-ui clearfix col12"><div class="tab col12"><input class="hide" type="radio" id="properties" name="tab-group" checked="true"><label class="keyline-top keyline-right tab-toggle pad0 pin-bottomleft z10 center col6" for="properties">Properties</label><div class="space-bottom1 col12 content"><table class="space-bottom0 marker-properties">'+r+"</table>"+(writable?'<div class="add-row-button add fl col3"><span class="icon-plus"> Add row</div><div class="fl text-right col9"><input type="checkbox" id="show-style" name="show-style" value="true" checked><label for="show-style">Show style properties</label></div>':"")+'</div></div><div class="space-bottom2 tab col12"><input class="hide" type="radio" id="info" name="tab-group"><label class="keyline-top tab-toggle pad0 pin-bottomright z10 center col6" for="info">Info</label><div class="space-bottom1 col12 content"><div class="marker-info">'+o+" </div></div></div></div>"+(writable?'<div class="clearfix col12 pad1 keyline-top"><div class="pill col6"><button class="save col6 major">Save</button> <button class="minor col6 cancel">Cancel</button></div><button class="col6 text-right pad0 delete-invert"><span class="icon-remove-sign"></span> Delete feature</button></div>':"");t.bindPopup(L.popup({closeButton:!1,maxWidth:500,maxHeight:400,autoPanPadding:[5,45],className:"geojsonio-feature"},t).setContent(s)),t.on("popupopen",function(t){!1===showStyle&&(d3.select("#show-style").property("checked",!1),d3.selectAll(".style-row").style("display","none")),d3.select("#show-style").on("click",function(){this.checked?(showStyle=!0,d3.selectAll(".style-row").style("display","")):(showStyle=!1,d3.selectAll(".style-row").style("display","none"))})})}}module.exports=function(a,t){return writable=!t,function(t){function e(){var e,t=a.mapLayer.toGeoJSON();geojsonToLayer(geojsonRewind(t),a.mapLayer),a.data.set({map:(t=a.mapLayer,e=[],t.eachLayer(function(t){"toGeoJSON"in t&&e.push(t.toGeoJSON())}),{type:"FeatureCollection",features:e})},"map")}a.map=L.mapbox.map(t.node(),null).setView([20,0],2).addControl(L.mapbox.geocoderControl("mapbox.places",{position:"topright"})),L.control.scale().setPosition("bottomright").addTo(a.map),a.map.zoomControl.setPosition("topright"),L.hash(a.map),a.mapLayer=L.featureGroup().addTo(a.map),writable&&(a.drawControl=new L.Control.Draw({position:"topright",edit:{featureGroup:a.mapLayer},draw:{circle:!1,polyline:{metric:"en-us"!==navigator.language&&"en-US"!==navigator.language},polygon:{metric:"en-us"!==navigator.language&&"en-US"!==navigator.language},marker:{icon:L.mapbox.marker.icon({})}}}).addTo(a.map),a.map.on("draw:edited",e).on("draw:deleted",e)),a.map.on("draw:created",function(t){a.mapLayer.addLayer(t.layer),e()}).on("popupopen",popup(a)),a.map.attributionControl.setPrefix('<a target="_blank" href="http://geojson.io/about.html">About</a>'),a.dispatch.on("change.map",function(){geojsonToLayer(a.data.get("map"),a.mapLayer)})}};
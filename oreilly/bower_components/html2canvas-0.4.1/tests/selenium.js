!function(){var c=require("sync-webdriver"),l=require("baconjs").Bacon,e=require("express"),s=(require("http"),require("https")),r=(require("url"),require("path"),require("base64-arraybuffer")),o=require("png-js"),u=require("fs"),a=require("googleapis"),i=require("jwt-sign"),f=8080,t=e(),p={red:"[1;31m",blue:"[1;36m",violet:"[0;35m",green:"[0;32m",clear:"[0m"},n=t.listen(f);function m(e){return l.combineTemplate({stat:l.fromNodeCallback(u.stat,e),item:e})}function d(e){return e.stat.isDirectory()}function g(e){return e.item}function h(e){return!d(e)}function v(e){return l.fromArray(e)}function b(n){return l.fromCallback(function(e){var t=r.decode(n);new o(t).decode(e)})}function w(e,t){for(var n=e.length,r=0,o=0;r<n;r++)t[r]-e[r]!=0&&o++;return 100-Math.round(o/e.length*1e4)/100}function C(e){return e.toDataURL("image/png").substring(22)}function S(){n.close()}function y(a,e,t){var n,r,s=[],i=[],c=[];e.forEach(function(e){var t,n,r=e.result,o=(t=e.test,n=null,a.some(function(e){return(n=e).test===t})?n:null),o=o?o.result:null,r={amount:Math.abs(r-o)<.01?0:r-o,test:e.test};null===o?c.push(r):0<r.amount?s.push(r):r.amount<0&&i.push(r)}),e=t,t=s,n=i,(0<(r=c).length||0<t.length||0<n.length)&&(console.log(0<n.length?p.red:p.green,e),n.forEach(function(e){console.log(p.red,e.amount+"%",e.test)}),t.forEach(function(e){console.log(p.green,e.amount+"%",e.test)}),r.forEach(function(e){console.log(p.blue,"NEW",e.test)}))}function A(e){return JSON.parse(e)}function E(){Object.keys(j).forEach(function(t){var e="tests/results/"+t+".json";try{y(JSON.parse(u.readFileSync(e)),j[t],t)}catch(e){}var n,r,o=new Date,a=JSON.stringify({browser:t,results:j[t],timestamp:o.toISOString()});process.env.MONGOLAB_APIKEY&&(n={host:"api.mongolab.com",port:443,path:"/api/1/databases/html2canvas/collections/webdriver-results?apiKey="+process.env.MONGOLAB_APIKEY+'&q={"browser":"'+t+'"}&fo=true&s={"timestamp":-1}'},r=n,l.fromCallback(function(n){s.get(r,function(e){var t="";e.on("data",function(e){t+=e}),e.on("end",function(){n(t)})})}).map(A).onValue(function(e){y(e.results,j[t],t),n.method="POST",n.path="/api/1/databases/html2canvas/collections/webdriver-results?apiKey="+process.env.MONGOLAB_APIKEY,n.headers={"Content-Type":"application/json","Content-Length":a.length},console.log("Sending results for",t);e=s.request(n,function(e){console.log(p.green,"Results sent for",t)});e.write(a),e.end()})),console.log(p.violet,"Writing",t+".json"),u.writeFile(e,a)})}function M(e){j[e.browser]||(j[e.browser]=[]),j[e.browser].push({test:e.testCase,result:e.accuracy})}function O(e){return(e.browser+"-"+(e.version||"release")+"-"+e.platform).replace(/ /g,"").toLowerCase()}function _(a){var s=l.fromCallback(R,"drive","v2").toProperty(),i=l.fromCallback(U,"95492219822.apps.googleusercontent.com").toProperty();return l.fromCallback(function(t){var e,n,r,o;new c.Session((e=a.browser,n=a.version,r=a.platform,o={},o=process.env.SAUCE_USERNAME&&process.env.SAUCE_ACCESS_KEY?{port:4445,hostname:"localhost",name:process.env.TRAVIS_JOB_ID||"Manual run",username:process.env.SAUCE_USERNAME,password:process.env.SAUCE_ACCESS_KEY,desiredCapabilities:{browserName:e,version:n,platform:r,"tunnel-identifier":process.env.TRAVIS_JOB_NUMBER}}:o),function(){var o=this,e=l.fromArray(x).flatMap(function(e){console.log(p.green,"STARTING",O(a),e,p.clear),o.url="http://localhost:"+f+"/"+e+"?selenium";var t=o.element(".html2canvas",15e3),t=l.constant(o.execute(C,t)),n=l.constant(o.screenshot()),r=t.flatMap(b).combine(n.flatMap(b),w);return console.log(p.green,"COMPLETE",O(a),e,p.clear),l.combineTemplate({browser:O(a),testCase:e,accuracy:r,dataUrl:t,screenshot:n})});u.existsSync("tests/certificate.pem")&&l.combineWith(T,s,i,l.combineWith(B,s,i,e.doAction(M).flatMap(k)).flatMap(q)).flatMap(N).onValue(I),e.onEnd(t)})})}function T(n,r,e){var o={value:"me",type:"anyone",role:"reader"};return e.map(function(e){var t=n.drive.permissions.insert({fileId:e.id}).withAuthClient(r);return t.body=o,t.fileData=e,t})}function q(e){return l.combineAsArray(e.map(function(e){return l.fromCallback(function(n){e.execute(function(e,t){e?console.log("Google drive error",e):n(t)})})}))}function N(e){return l.combineAsArray(e.map(function(r){return l.fromCallback(function(n){r.execute(function(e,t){e?console.log("Google drive error",e):n(r.fileData)})})}))}function k(e){var t="tests/results/"+e.browser+"-"+e.testCase.replace(/\//g,"-")+"-html2canvas.png",n="tests/results/"+e.browser+"-"+e.testCase.replace(/\//g,"-")+"-screencapture.png";return l.combineTemplate({name:e.testCase,dataurl:l.fromNodeCallback(u.writeFile,t,e.dataUrl,"base64").map(function(){return t}),screenshot:l.fromNodeCallback(u.writeFile,n,e.screenshot,"base64").map(function(){return n})})}function I(e){e.forEach(function(e){console.log(e.webContentLink)})}function R(e,t,n){a.discover(e,t).execute(function(e,t){e||n(t)})}function U(e,n){var t={iss:"95492219822@developer.gserviceaccount.com",scope:"https://www.googleapis.com/auth/drive",aud:"https://accounts.google.com/o/oauth2/token",exp:1800+~~((new Date).getTime()/1e3),iat:~~((new Date).getTime()/1e3-60)},r=u.readFileSync("tests/certificate.pem","utf8"),t={method:"POST",uri:"https://accounts.google.com/o/oauth2/token",form:{grant_type:"urn:ietf:params:oauth:grant-type:jwt-bearer",assertion:i.sign(t,r)},json:!0},o=new a.OAuth2Client(e,"","");o.transporter.request(t,function(e,t){e||(o.credentials=t,n(o))})}function B(e,t,n){return[e.drive.files.insert({title:n.dataurl,mimeType:"image/png",description:process.env.TRAVIS_JOB_ID}).withMedia("image/png",u.readFileSync(n.dataurl)).withAuthClient(t),e.drive.files.insert({title:n.screenshot,mimeType:"image/png",description:process.env.TRAVIS_JOB_ID}).withMedia("image/png",u.readFileSync(n.screenshot)).withAuthClient(t)]}function L(){var e=l.sequentially(1e3,[{browser:"chrome",platform:"Windows 7"},{browser:"firefox",version:"15",platform:"Windows 7"},{browser:"internet explorer",version:"9",platform:"Windows 7"},{browser:"internet explorer",version:"10",platform:"Windows 8"},{browser:"safari",version:"6",platform:"OS X 10.8"},{browser:"chrome",platform:"OS X 10.8"}]).flatMap(_);e.onEnd(E),e.onEnd(S)}t.use("/index.html",function(e,t){t.send("<ul>"+x.map(function(e){return"<li><a href='"+e+"'>"+e+"</a></li>"}).join("")+"</ul>")}),t.use("/",e.static(__dirname+"/../"));var x=[],j={},D=function e(t){var n=l.fromNodeCallback(u.readdir,t).flatMap(v).map(function(e){return t+"/"+e}).flatMap(m);return n.filter(h).map(g).merge(n.filter(d).map(g).flatMap(e))}("tests/cases");D.onValue(function(e){x.push(e)}),exports.tests=function(){D.onEnd(L)}}();
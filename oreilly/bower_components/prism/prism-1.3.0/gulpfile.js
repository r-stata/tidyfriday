var gulp=require("gulp"),rename=require("gulp-rename"),uglify=require("gulp-uglify"),header=require("gulp-header"),concat=require("gulp-concat"),replace=require("gulp-replace"),fs=require("fs"),paths={componentsFile:"components.js",components:["components/**/*.js","!components/**/*.min.js"],main:["components/prism-core.js","components/prism-markup.js","components/prism-css.js","components/prism-clike.js","components/prism-javascript.js","plugins/file-highlight/prism-file-highlight.js"],plugins:["plugins/**/*.js","!plugins/**/*.min.js"],showLanguagePlugin:"plugins/show-language/prism-show-language.js",autoloaderPlugin:"plugins/autoloader/prism-autoloader.js",changelog:"CHANGELOG.md"};gulp.task("components",function(){return gulp.src(paths.components).pipe(uglify()).pipe(rename({suffix:".min"})).pipe(gulp.dest("components"))}),gulp.task("build",function(){return gulp.src(paths.main).pipe(header("\n/* **********************************************\n     Begin <%= file.relative %>\n********************************************** */\n\n")).pipe(concat("prism.js")).pipe(gulp.dest("./"))}),gulp.task("plugins",["languages-plugins"],function(){return gulp.src(paths.plugins).pipe(uglify()).pipe(rename({suffix:".min"})).pipe(gulp.dest("plugins"))}),gulp.task("watch",function(){gulp.watch(paths.components,["components","build"]),gulp.watch(paths.plugins,["plugins","build"])}),gulp.task("languages-plugins",function(c){fs.readFile(paths.componentsFile,{encoding:"utf-8"},function(e,n){if(e)c(e);else{n=n.replace(/^var\s+components\s*=\s*|;\s*$/g,"");try{n=JSON.parse(n);var p,s,i={},u={};for(p in n.languages)"meta"!==p&&((s=n.languages[p].displayTitle||n.languages[p].title)!==p.substring(0,1).toUpperCase()+p.substring(1)&&(i[p]=s),n.languages[p].require&&(u[p]=n.languages[p].require));function g(){++r===o&&c&&c()}var l=JSON.stringify(i),a=JSON.stringify(u),t=[{plugin:paths.showLanguagePlugin,map:l},{plugin:paths.autoloaderPlugin,map:a}],r=0,o=t.length;t.forEach(function(e){e=gulp.src(e.plugin).pipe(replace(/\/\*languages_placeholder\[\*\/[\s\S]*?\/\*\]\*\//,"/*languages_placeholder[*/"+e.map+"/*]*/")).pipe(gulp.dest(e.plugin.substring(0,e.plugin.lastIndexOf("/"))));e.on("error",g),e.on("end",g)})}catch(e){c(e)}}})}),gulp.task("changelog",function(e){return gulp.src(paths.changelog).pipe(replace(/#(\d+)(?![\d\]])/g,"[#$1](https://github.com/PrismJS/prism/issues/$1)")).pipe(replace(/\[[\da-f]+(?:, *[\da-f]+)*\]/g,function(e){return e.replace(/([\da-f]{7})[\da-f]*/g,"[`$1`](https://github.com/PrismJS/prism/commit/$1)")})).pipe(gulp.dest("."))}),gulp.task("default",["components","plugins","build"]);
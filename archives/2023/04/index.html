<!DOCTYPE html>
<html lang="zh-cn">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8">
  <title>归档 | 微信公众号 RStata</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Canonical links -->
  <link rel="canonical" href="https://tidyfriday.cn/archives/2023/04/index.html">
  <!-- Alternative links -->
  
  <!-- Icon -->
  <link rel="icon" href="/images/pad.svg">
  <meta name="msapplication-TileColor" content="#2f83cd">
  <meta name="msapplication-TileImage" content="/images/pad.svg">
  <!-- CSS -->
  <!-- build:css build/css/navy.css -->
  
<link rel="stylesheet" href="/css/navy.css">

  <!-- endbuild -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-lato@0.0.75/index.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css">
  <!-- RSS -->
  <link rel="alternate" href="/atom.xml" title="微信公众号 RStata" type="application/atom+xml">
  <!-- Open Graph -->
  <meta name="description" content="一起来学习 R 语言和 Stata 吧！">
<meta property="og:type" content="website">
<meta property="og:title" content="归档">
<meta property="og:url" content="https://tidyfriday.cn/archives/2023/04/">
<meta property="og:site_name" content="微信公众号 RStata">
<meta property="og:description" content="一起来学习 R 语言和 Stata 吧！">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="RStata">
<meta name="twitter:card" content="summary">
  <!-- Google Analytics -->
  
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <header id="header" class="wrapper">
  <div id="header-inner" class="inner">
    <h1 id="logo-wrap">
      <a id="logo" href="/">RStata</a>
    </h1>
    <nav id="main-nav">
      <a href="/archives/" class="main-nav-link">归档</a><a href="/r-gallery/" class="main-nav-link">R 语言绘图案例</a><a href="/stata-gallery/" class="main-nav-link">Stata 绘图案例</a><a href="/rsdb2/" class="main-nav-link">RStata课程与数据库</a><a href="/templates/" class="main-nav-link">模板库</a><a href="/books/" class="main-nav-link">电子书</a><a href="/about/" class="main-nav-link">关于</a>
      <div id="search-input-wrap">
        <div id="search-input-icon">
          <i class="fa fa-search"></i>
        </div>
        <input type="search" id="search-input" placeholder="Search...">
      </div>
    </nav>
    <div>
      <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/r-stata" class="main-nav-link"><i class="fa fa-github-alt"></i></a>
    </div>
    <a id="mobile-nav-toggle">
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
    </a>
  </div>
</header>

    
<div id="content-wrap">
  <div class="wrapper">
    <div class="inner">
      
        
          <article class="article post" itemscope itemtype="http://schema.org/Article">
  <header class="article-header">
    
      <h1>
        <a href="/posts/38638/" class="article-title" itemprop="name">R 语言：如何为区县名称添加行政区划代码</a>
      </h1>
    
    <a href="/posts/38638/" class="article-date"><time datetime="2023-04-21T11:30:00.000Z">2023-04-21</time></a>
  </header>
  <div class="article-content" itemprop="articleBody">
    <p>在之前的课程「R 语言：如何整理 2022 年县域统计年鉴：caj 文件转 pdf、文本识别与数据清洗」中我们讲解了如何从 caj 文件中提取表格数据的方法，今天我们再来学习下如何根据区县名称匹配行政区划代码，另外在该过程中还可以检查区县名称的识别错误。最后我们再使用整理得到的数据绘制一幅区县地图。</p>
<p>首先我们使用上次课的代码处理“整理结果3.xlsx”：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 处理 “整理结果3.xlsx”</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">readxl<span class="operator">::</span>read_xlsx<span class="punctuation">(</span><span class="string">&quot;整理结果3.xlsx&quot;</span><span class="punctuation">,</span> col_names <span class="operator">=</span> <span class="built_in">LETTERS</span><span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">12</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> df </span><br><span class="line">df <span class="operator">%&gt;%</span> </span><br><span class="line">  fill<span class="punctuation">(</span>A<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  dplyr<span class="operator">::</span>filter<span class="punctuation">(</span><span class="operator">!</span><span class="punctuation">(</span><span class="built_in">is.na</span><span class="punctuation">(</span>D<span class="punctuation">)</span> <span class="operator">&amp;</span> <span class="built_in">is.na</span><span class="punctuation">(</span>E<span class="punctuation">)</span> <span class="operator">&amp;</span> <span class="built_in">is.na</span><span class="punctuation">(</span><span class="built_in">F</span><span class="punctuation">)</span> </span><br><span class="line">                  <span class="operator">&amp;</span> <span class="built_in">is.na</span><span class="punctuation">(</span>G<span class="punctuation">)</span> <span class="operator">&amp;</span> <span class="built_in">is.na</span><span class="punctuation">(</span>H<span class="punctuation">)</span> <span class="operator">&amp;</span> <span class="built_in">is.na</span><span class="punctuation">(</span>I<span class="punctuation">)</span></span><br><span class="line">                  <span class="operator">&amp;</span> <span class="built_in">is.na</span><span class="punctuation">(</span>J<span class="punctuation">)</span> <span class="operator">&amp;</span> <span class="built_in">is.na</span><span class="punctuation">(</span>K<span class="punctuation">)</span> <span class="operator">&amp;</span> <span class="built_in">is.na</span><span class="punctuation">(</span>L<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span>B <span class="operator">=</span> str_remove_all<span class="punctuation">(</span>B<span class="punctuation">,</span> <span class="string">&quot; &quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span>B <span class="operator">=</span> str_remove_all<span class="punctuation">(</span>B<span class="punctuation">,</span> <span class="string">&quot;,&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         B <span class="operator">=</span> str_remove_all<span class="punctuation">(</span>B<span class="punctuation">,</span> <span class="string">&quot;-&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         B <span class="operator">=</span> str_remove_all<span class="punctuation">(</span>B<span class="punctuation">,</span> <span class="string">&quot;\\.&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         B <span class="operator">=</span> str_remove_all<span class="punctuation">(</span>B<span class="punctuation">,</span> <span class="string">&quot;~&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         B <span class="operator">=</span> str_remove_all<span class="punctuation">(</span>B<span class="punctuation">,</span> <span class="string">&quot;・&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         B <span class="operator">=</span> str_remove_all<span class="punctuation">(</span>B<span class="punctuation">,</span> <span class="string">&quot;，&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         B <span class="operator">=</span> str_remove_all<span class="punctuation">(</span>B<span class="punctuation">,</span> <span class="string">&quot;、&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  dplyr<span class="operator">::</span>filter<span class="punctuation">(</span><span class="operator">!</span><span class="built_in">is.na</span><span class="punctuation">(</span>B<span class="punctuation">)</span> <span class="operator">&amp;</span> B <span class="operator">!=</span> <span class="string">&quot;一、基本情况行政区域面积&quot;</span> <span class="operator">&amp;</span> B <span class="operator">!=</span> <span class="string">&quot;一基本情况行政区域面积&quot;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span>B <span class="operator">=</span> if_else<span class="punctuation">(</span>B <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;提供住宿的民政服务机构床位数&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              <span class="string">&quot;提供住宿的民谢艮务机构床位数&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              <span class="string">&quot;提供住宿的民政0艮务机构床位数&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                     <span class="string">&quot;提供住宿的民政服务机构床位数&quot;</span><span class="punctuation">,</span> B<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         B <span class="operator">=</span> if_else<span class="punctuation">(</span>B <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;提供住宿的民呦艮务机构&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              <span class="string">&quot;提供住宿的民政^务机构&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              <span class="string">&quot;提供住宿的民斑艮务机构&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              <span class="string">&quot;提供住宿的民班艮务机构&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                     <span class="string">&quot;提供住宿的民政服务机构&quot;</span><span class="punctuation">,</span> B<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span>z <span class="operator">=</span> if_else<span class="punctuation">(</span>B <span class="operator">==</span> <span class="string">&quot;指标&quot;</span><span class="punctuation">,</span> row.names<span class="punctuation">(</span>.<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span>z <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>z<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  fill<span class="punctuation">(</span>z<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  select<span class="punctuation">(</span><span class="operator">-</span>C<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  gather<span class="punctuation">(</span>D<span class="operator">:</span>L<span class="punctuation">,</span> key <span class="operator">=</span> <span class="string">&quot;variable&quot;</span><span class="punctuation">,</span> value <span class="operator">=</span> <span class="string">&quot;value&quot;</span><span class="punctuation">)</span>  <span class="operator">%&gt;%</span> </span><br><span class="line">  spread<span class="punctuation">(</span>B<span class="punctuation">,</span> value<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  select<span class="punctuation">(</span>z<span class="punctuation">,</span> A<span class="punctuation">,</span> 指标<span class="punctuation">,</span> everything<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  dplyr<span class="operator">::</span>filter<span class="punctuation">(</span><span class="operator">!</span><span class="built_in">is.na</span><span class="punctuation">(</span>指标<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  select<span class="punctuation">(</span><span class="operator">-</span>variable<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  type_convert<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  rename<span class="punctuation">(</span>省 <span class="operator">=</span> A<span class="punctuation">,</span> 县 <span class="operator">=</span> 指标<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  select<span class="punctuation">(</span>省<span class="punctuation">,</span> 县<span class="punctuation">,</span> 行政区域面积<span class="punctuation">,</span> 乡<span class="punctuation">,</span> 镇<span class="punctuation">,</span> 街道办事处<span class="punctuation">,</span> 户籍人口<span class="punctuation">,</span> </span><br><span class="line">         地区生产总值<span class="punctuation">,</span> 第一产业增加值<span class="punctuation">,</span> 第二产业增加值<span class="punctuation">,</span> 第三产业增加值<span class="punctuation">,</span> </span><br><span class="line">         地方一般公共预算收入<span class="punctuation">,</span> 地方一般公共预算支出<span class="punctuation">,</span> 住户存款余额<span class="punctuation">,</span> </span><br><span class="line">         年末金融机构各项贷款余额<span class="punctuation">,</span> 设施农业种植占地面积<span class="punctuation">,</span> 油料产量<span class="punctuation">,</span> </span><br><span class="line">         棉花产量<span class="punctuation">,</span> 规模以上工业企业<span class="punctuation">,</span> 固定电话用户<span class="punctuation">,</span> 普通中学在校学生<span class="punctuation">,</span> </span><br><span class="line">         小学在校学生<span class="punctuation">,</span> 医疗卫生机构床位<span class="punctuation">,</span> 提供住宿的民政服务机构<span class="punctuation">,</span> </span><br><span class="line">         提供住宿的民政服务机构床位数<span class="punctuation">)</span> <span class="operator">-&gt;</span> df4 </span><br><span class="line"></span><br><span class="line">df4 </span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt; # A tibble: 2,054 × 25</span></span><br><span class="line"><span class="comment">#&gt;    省     县     行政区域面积    乡    镇 街道办事处 户籍人口 地区生产总值</span></span><br><span class="line"><span class="comment">#&gt;    &lt;chr&gt;  &lt;chr&gt;         &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;</span></span><br><span class="line"><span class="comment">#&gt;  1 安徽省 肥东县         2182     6    12         NA    108.       8114070</span></span><br><span class="line"><span class="comment">#&gt;  2 安徽省 肥西县         1695     4     8         NA     85.6     10186781</span></span><br><span class="line"><span class="comment">#&gt;  3 安徽省 庐江县         2344    NA    17         NA    120        5471895</span></span><br><span class="line"><span class="comment">#&gt;  4 安徽省 巢湖市         2046    NA    12          5     85.4      5231019</span></span><br><span class="line"><span class="comment">#&gt;  5 安徽省 湾社区          650    NA     5         NA     35.4      3831248</span></span><br><span class="line"><span class="comment">#&gt;  6 安徽省 长丰县         1841     2    12         NA     81.1      7619440</span></span><br><span class="line"><span class="comment">#&gt;  7 安徽省 繁昌区          585    NA     6         NA     27.2      3641111</span></span><br><span class="line"><span class="comment">#&gt;  8 安徽省 南陵县         1264    NA     8         NA     54.3      3206882</span></span><br><span class="line"><span class="comment">#&gt;  9 安徽省 无为市         2022    NA    20         NA    119.       5770037</span></span><br><span class="line"><span class="comment">#&gt; 10 安徽省 怀远县         2192     1    17         NA    134.       3562589</span></span><br><span class="line"><span class="comment">#&gt; # ℹ 2,044 more rows</span></span><br><span class="line"><span class="comment">#&gt; # ℹ 17 more variables: 第一产业增加值 &lt;dbl&gt;, 第二产业增加值 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   第三产业增加值 &lt;dbl&gt;, 地方一般公共预算收入 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   地方一般公共预算支出 &lt;dbl&gt;, 住户存款余额 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   年末金融机构各项贷款余额 &lt;dbl&gt;, 设施农业种植占地面积 &lt;dbl&gt;, 油料产量 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   棉花产量 &lt;dbl&gt;, 规模以上工业企业 &lt;dbl&gt;, 固定电话用户 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   普通中学在校学生 &lt;dbl&gt;, 小学在校学生 &lt;dbl&gt;, 医疗卫生机构床位 &lt;dbl&gt;, …</span></span><br></pre></td></tr></table></figure>

<p>由于之前我分享的县域统计年鉴数据都是使用的 2020 年行政区划代码，所以这次我们也同样。</p>
<p>2020 年行政区划代码可以从地理矢量数据得到（为了方便绘制地图）：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>sf<span class="punctuation">)</span></span><br><span class="line">read_sf<span class="punctuation">(</span><span class="string">&quot;2020行政区划/县.shp&quot;</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> county </span><br><span class="line"><span class="comment"># 删除地理信息</span></span><br><span class="line">county <span class="operator">%&gt;%</span> </span><br><span class="line">  st_drop_geometry<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  select<span class="punctuation">(</span><span class="operator">-</span>contains<span class="punctuation">(</span><span class="string">&quot;类型&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> countydb </span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 省-县 的组合有无重复的</span></span><br><span class="line">countydb <span class="operator">%&gt;%</span> </span><br><span class="line">  group_by<span class="punctuation">(</span>省<span class="punctuation">,</span> 县<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span>n <span class="operator">=</span> n<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  arrange<span class="punctuation">(</span>desc<span class="punctuation">(</span>n<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  ungroup<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> countydb </span><br><span class="line"></span><br><span class="line"><span class="comment"># 这些重复的可能会影响下一步的匹配，所以先删除了</span></span><br><span class="line">countydb <span class="operator">%&gt;%</span> </span><br><span class="line">  filter<span class="punctuation">(</span>n <span class="operator">&lt;=</span> <span class="number">1</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> countycode1 </span><br><span class="line">countycode1 </span><br><span class="line"><span class="comment">#&gt; # A tibble: 2,862 × 7</span></span><br><span class="line"><span class="comment">#&gt;    省     省代码 市     市代码 县     县代码     n</span></span><br><span class="line"><span class="comment">#&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;int&gt;</span></span><br><span class="line"><span class="comment">#&gt;  1 安徽省 340000 安庆市 340800 大观区 340803     1</span></span><br><span class="line"><span class="comment">#&gt;  2 安徽省 340000 安庆市 340800 怀宁县 340822     1</span></span><br><span class="line"><span class="comment">#&gt;  3 安徽省 340000 安庆市 340800 潜山市 340882     1</span></span><br><span class="line"><span class="comment">#&gt;  4 安徽省 340000 安庆市 340800 宿松县 340826     1</span></span><br><span class="line"><span class="comment">#&gt;  5 安徽省 340000 安庆市 340800 太湖县 340825     1</span></span><br><span class="line"><span class="comment">#&gt;  6 安徽省 340000 安庆市 340800 桐城市 340881     1</span></span><br><span class="line"><span class="comment">#&gt;  7 安徽省 340000 安庆市 340800 望江县 340827     1</span></span><br><span class="line"><span class="comment">#&gt;  8 安徽省 340000 安庆市 340800 宜秀区 340811     1</span></span><br><span class="line"><span class="comment">#&gt;  9 安徽省 340000 安庆市 340800 迎江区 340802     1</span></span><br><span class="line"><span class="comment">#&gt; 10 安徽省 340000 安庆市 340800 岳西县 340828     1</span></span><br><span class="line"><span class="comment">#&gt; # ℹ 2,852 more rows</span></span><br></pre></td></tr></table></figure>

<p>首先匹配下看看能成功多少：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tidylog 包的 join 族函数可以显示匹配效果：</span></span><br><span class="line">df4 <span class="operator">%&gt;%</span> </span><br><span class="line">  tidylog<span class="operator">::</span>left_join<span class="punctuation">(</span>countycode1<span class="punctuation">)</span> </span><br><span class="line"><span class="comment">#&gt; # A tibble: 2,054 × 30</span></span><br><span class="line"><span class="comment">#&gt;    省     县     行政区域面积    乡    镇 街道办事处 户籍人口 地区生产总值</span></span><br><span class="line"><span class="comment">#&gt;    &lt;chr&gt;  &lt;chr&gt;         &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;</span></span><br><span class="line"><span class="comment">#&gt;  1 安徽省 肥东县         2182     6    12         NA    108.       8114070</span></span><br><span class="line"><span class="comment">#&gt;  2 安徽省 肥西县         1695     4     8         NA     85.6     10186781</span></span><br><span class="line"><span class="comment">#&gt;  3 安徽省 庐江县         2344    NA    17         NA    120        5471895</span></span><br><span class="line"><span class="comment">#&gt;  4 安徽省 巢湖市         2046    NA    12          5     85.4      5231019</span></span><br><span class="line"><span class="comment">#&gt;  5 安徽省 湾社区          650    NA     5         NA     35.4      3831248</span></span><br><span class="line"><span class="comment">#&gt;  6 安徽省 长丰县         1841     2    12         NA     81.1      7619440</span></span><br><span class="line"><span class="comment">#&gt;  7 安徽省 繁昌区          585    NA     6         NA     27.2      3641111</span></span><br><span class="line"><span class="comment">#&gt;  8 安徽省 南陵县         1264    NA     8         NA     54.3      3206882</span></span><br><span class="line"><span class="comment">#&gt;  9 安徽省 无为市         2022    NA    20         NA    119.       5770037</span></span><br><span class="line"><span class="comment">#&gt; 10 安徽省 怀远县         2192     1    17         NA    134.       3562589</span></span><br><span class="line"><span class="comment">#&gt; # ℹ 2,044 more rows</span></span><br><span class="line"><span class="comment">#&gt; # ℹ 22 more variables: 第一产业增加值 &lt;dbl&gt;, 第二产业增加值 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   第三产业增加值 &lt;dbl&gt;, 地方一般公共预算收入 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   地方一般公共预算支出 &lt;dbl&gt;, 住户存款余额 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   年末金融机构各项贷款余额 &lt;dbl&gt;, 设施农业种植占地面积 &lt;dbl&gt;, 油料产量 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   棉花产量 &lt;dbl&gt;, 规模以上工业企业 &lt;dbl&gt;, 固定电话用户 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   普通中学在校学生 &lt;dbl&gt;, 小学在校学生 &lt;dbl&gt;, 医疗卫生机构床位 &lt;dbl&gt;, …</span></span><br></pre></td></tr></table></figure>

<p>查看匹配失败的：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看匹配失败的 </span></span><br><span class="line">df4 <span class="operator">%&gt;%</span> </span><br><span class="line">  tidylog<span class="operator">::</span>anti_join<span class="punctuation">(</span>countycode1<span class="punctuation">)</span> </span><br><span class="line"><span class="comment">#&gt; # A tibble: 168 × 25</span></span><br><span class="line"><span class="comment">#&gt;    省     县        行政区域面积    乡    镇 街道办事处 户籍人口 地区生产总值</span></span><br><span class="line"><span class="comment">#&gt;    &lt;chr&gt;  &lt;chr&gt;            &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;</span></span><br><span class="line"><span class="comment">#&gt;  1 安徽省 湾社区             650    NA     5         NA     35.4      3831248</span></span><br><span class="line"><span class="comment">#&gt;  2 安徽省 滩溪县            1982    NA    11         NA    114.       5407788</span></span><br><span class="line"><span class="comment">#&gt;  3 安徽省 板阳县            1473     1    15         NA     78.7      1882758</span></span><br><span class="line"><span class="comment">#&gt;  4 安徽省 夥县               857     3     5         NA      9.2       509979</span></span><br><span class="line"><span class="comment">#&gt;  5 安徽省 扬山县            1197    NA    13         NA    101.       2544835</span></span><br><span class="line"><span class="comment">#&gt;  6 重庆市 由日 忠县         2187     6    19          4     96.2      4885521</span></span><br><span class="line"><span class="comment">#&gt;  7 重庆市 新都区             497    NA     2          7     85.6     10001115</span></span><br><span class="line"><span class="comment">#&gt;  8 福建省 沙县区            1799     4     6          2     27.1      3544375</span></span><br><span class="line"><span class="comment">#&gt;  9 福建省 龙海区            1320     2    11          1     91.2     12657788</span></span><br><span class="line"><span class="comment">#&gt; 10 福建省 长泰区             900     1     4         NA     21.1      3752268</span></span><br><span class="line"><span class="comment">#&gt; # ℹ 158 more rows</span></span><br><span class="line"><span class="comment">#&gt; # ℹ 17 more variables: 第一产业增加值 &lt;dbl&gt;, 第二产业增加值 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   第三产业增加值 &lt;dbl&gt;, 地方一般公共预算收入 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   地方一般公共预算支出 &lt;dbl&gt;, 住户存款余额 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   年末金融机构各项贷款余额 &lt;dbl&gt;, 设施农业种植占地面积 &lt;dbl&gt;, 油料产量 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   棉花产量 &lt;dbl&gt;, 规模以上工业企业 &lt;dbl&gt;, 固定电话用户 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   普通中学在校学生 &lt;dbl&gt;, 小学在校学生 &lt;dbl&gt;, 医疗卫生机构床位 &lt;dbl&gt;, …</span></span><br></pre></td></tr></table></figure>

<p>可以看到很多是由于空格和杂乱字符导致的匹配失败，所以我们先去除：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df4 <span class="operator">%&gt;%</span> </span><br><span class="line">  tidylog<span class="operator">::</span>mutate<span class="punctuation">(</span>县 <span class="operator">=</span> str_remove_all<span class="punctuation">(</span>县<span class="punctuation">,</span> <span class="string">&quot;[\\s;:]&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> df4 </span><br><span class="line">然后再匹配：</span><br><span class="line"></span><br><span class="line">df4 <span class="operator">%&gt;%</span> </span><br><span class="line">  tidylog<span class="operator">::</span>anti_join<span class="punctuation">(</span>countycode1<span class="punctuation">)</span> </span><br><span class="line"><span class="comment">#&gt; # A tibble: 83 × 25</span></span><br><span class="line"><span class="comment">#&gt;    省     县       行政区域面积    乡    镇 街道办事处 户籍人口 地区生产总值</span></span><br><span class="line"><span class="comment">#&gt;    &lt;chr&gt;  &lt;chr&gt;           &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;</span></span><br><span class="line"><span class="comment">#&gt;  1 安徽省 湾社区            650    NA     5         NA     35.4      3831248</span></span><br><span class="line"><span class="comment">#&gt;  2 安徽省 滩溪县           1982    NA    11         NA    114.       5407788</span></span><br><span class="line"><span class="comment">#&gt;  3 安徽省 板阳县           1473     1    15         NA     78.7      1882758</span></span><br><span class="line"><span class="comment">#&gt;  4 安徽省 夥县              857     3     5         NA      9.2       509979</span></span><br><span class="line"><span class="comment">#&gt;  5 安徽省 扬山县           1197    NA    13         NA    101.       2544835</span></span><br><span class="line"><span class="comment">#&gt;  6 重庆市 由日忠县         2187     6    19          4     96.2      4885521</span></span><br><span class="line"><span class="comment">#&gt;  7 重庆市 新都区            497    NA     2          7     85.6     10001115</span></span><br><span class="line"><span class="comment">#&gt;  8 福建省 沙县区           1799     4     6          2     27.1      3544375</span></span><br><span class="line"><span class="comment">#&gt;  9 福建省 龙海区           1320     2    11          1     91.2     12657788</span></span><br><span class="line"><span class="comment">#&gt; 10 福建省 长泰区            900     1     4         NA     21.1      3752268</span></span><br><span class="line"><span class="comment">#&gt; # ℹ 73 more rows</span></span><br><span class="line"><span class="comment">#&gt; # ℹ 17 more variables: 第一产业增加值 &lt;dbl&gt;, 第二产业增加值 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   第三产业增加值 &lt;dbl&gt;, 地方一般公共预算收入 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   地方一般公共预算支出 &lt;dbl&gt;, 住户存款余额 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   年末金融机构各项贷款余额 &lt;dbl&gt;, 设施农业种植占地面积 &lt;dbl&gt;, 油料产量 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   棉花产量 &lt;dbl&gt;, 规模以上工业企业 &lt;dbl&gt;, 固定电话用户 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   普通中学在校学生 &lt;dbl&gt;, 小学在校学生 &lt;dbl&gt;, 医疗卫生机构床位 &lt;dbl&gt;, …</span></span><br></pre></td></tr></table></figure>

<p>可以看到这个时候匹配不成功的就不是很多了，下面我们需要结合百度和 countycode1.dta 来逐个检查修正：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">DT<span class="operator">::</span>datatable<span class="punctuation">(</span>countycode1<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p><img src="https://mdniceczx.oss-cn-beijing.aliyuncs.com/20230421232906.png" alt=""></p>
<p>这里建议先保存成一个 xlsx 文件，然后在 Excel 里面进行更正：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df4 <span class="operator">%&gt;%</span> </span><br><span class="line">  anti_join<span class="punctuation">(</span>countycode1<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  writexl<span class="operator">::</span>write_xlsx<span class="punctuation">(</span><span class="string">&quot;待修正.xlsx&quot;</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 待修正2.xlsx 是我手动调整之后得到的结果</span></span><br><span class="line">readxl<span class="operator">::</span>read_xlsx<span class="punctuation">(</span><span class="string">&quot;待修正2.xlsx&quot;</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> dftemp </span><br><span class="line"></span><br><span class="line">dftemp <span class="operator">%&gt;%</span> </span><br><span class="line">  tidylog<span class="operator">::</span>anti_join<span class="punctuation">(</span>countycode1<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#&gt; # A tibble: 0 × 25</span></span><br><span class="line"><span class="comment">#&gt; # ℹ 25 variables: 省 &lt;chr&gt;, 县 &lt;chr&gt;, 行政区域面积 &lt;dbl&gt;, 乡 &lt;dbl&gt;, 镇 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   街道办事处 &lt;dbl&gt;, 户籍人口 &lt;dbl&gt;, 地区生产总值 &lt;dbl&gt;, 第一产业增加值 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   第二产业增加值 &lt;dbl&gt;, 第三产业增加值 &lt;dbl&gt;, 地方一般公共预算收入 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   地方一般公共预算支出 &lt;dbl&gt;, 住户存款余额 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   年末金融机构各项贷款余额 &lt;dbl&gt;, 设施农业种植占地面积 &lt;dbl&gt;, 油料产量 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   棉花产量 &lt;dbl&gt;, 规模以上工业企业 &lt;dbl&gt;, 固定电话用户 &lt;dbl&gt;,</span></span><br><span class="line"><span class="comment">#&gt; #   普通中学在校学生 &lt;dbl&gt;, 小学在校学生 &lt;dbl&gt;, 医疗卫生机构床位 &lt;dbl&gt;, …</span></span><br></pre></td></tr></table></figure>

<p>这个时候就没有不匹配的了：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df4 <span class="operator">%&gt;%</span> </span><br><span class="line">  anti_join<span class="punctuation">(</span></span><br><span class="line">    df4 <span class="operator">%&gt;%</span> </span><br><span class="line">      select<span class="punctuation">(</span>省<span class="punctuation">,</span> 县<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">      anti_join<span class="punctuation">(</span>countycode1<span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  bind_rows<span class="punctuation">(</span>dftemp<span class="punctuation">)</span> <span class="operator">-&gt;</span> df5 </span><br><span class="line"></span><br><span class="line">df5 <span class="operator">%&gt;%</span> </span><br><span class="line">  tidylog<span class="operator">::</span>left_join<span class="punctuation">(</span>countycode1<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  select<span class="punctuation">(</span>省<span class="punctuation">,</span> 省代码<span class="punctuation">,</span> 市<span class="punctuation">,</span> 市代码<span class="punctuation">,</span> 县<span class="punctuation">,</span> 县代码<span class="punctuation">,</span> everything<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> df5 </span><br></pre></td></tr></table></figure>

<p>然后我们再对变量进行重命名（和之前年份的保持一致）：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df5 <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span>乡 <span class="operator">=</span> if_else<span class="punctuation">(</span><span class="built_in">is.na</span><span class="punctuation">(</span>乡<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> 乡<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         镇 <span class="operator">=</span> if_else<span class="punctuation">(</span><span class="built_in">is.na</span><span class="punctuation">(</span>镇<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> 镇<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span>乡镇个数_个 <span class="operator">=</span> 乡 <span class="operator">+</span> 镇<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  rename<span class="punctuation">(</span></span><br><span class="line">    乡_个 <span class="operator">=</span> 乡<span class="punctuation">,</span> </span><br><span class="line">    镇_个 <span class="operator">=</span> 镇<span class="punctuation">,</span> </span><br><span class="line">    行政区域土地面积_平方公里 <span class="operator">=</span> 行政区域面积<span class="punctuation">,</span> </span><br><span class="line">    街道办事处个数_个 <span class="operator">=</span> 街道办事处<span class="punctuation">,</span> </span><br><span class="line">    户籍人口_人 <span class="operator">=</span> 户籍人口<span class="punctuation">,</span> </span><br><span class="line">    国内生产总值_万元 <span class="operator">=</span> 地区生产总值<span class="punctuation">,</span></span><br><span class="line">    第一产业增加值_万元 <span class="operator">=</span> 第一产业增加值<span class="punctuation">,</span></span><br><span class="line">    第二产业增加值_万元 <span class="operator">=</span> 第二产业增加值<span class="punctuation">,</span> </span><br><span class="line">    第三产业增加值_万元 <span class="operator">=</span> 第三产业增加值<span class="punctuation">,</span></span><br><span class="line">    一般公共预算收入_万元 <span class="operator">=</span> 地方一般公共预算收入<span class="punctuation">,</span></span><br><span class="line">    一般公共预算支出_万元 <span class="operator">=</span> 地方一般公共预算支出<span class="punctuation">,</span></span><br><span class="line">    住户储蓄存款余额_万元 <span class="operator">=</span> 住户存款余额<span class="punctuation">,</span> </span><br><span class="line">    年末各项贷款余额_万元 <span class="operator">=</span> 年末金融机构各项贷款余额<span class="punctuation">,</span> </span><br><span class="line">    设施农业占地面积_公顷 <span class="operator">=</span> 设施农业种植占地面积<span class="punctuation">,</span> </span><br><span class="line">    油料产量_吨 <span class="operator">=</span> 油料产量<span class="punctuation">,</span> </span><br><span class="line">    棉花产量_吨 <span class="operator">=</span> 棉花产量<span class="punctuation">,</span> </span><br><span class="line">    规模以上工业企业个数_个 <span class="operator">=</span> 规模以上工业企业<span class="punctuation">,</span> </span><br><span class="line">    固定电话用户_户 <span class="operator">=</span> 固定电话用户<span class="punctuation">,</span> </span><br><span class="line">    普通中学在校学生_人 <span class="operator">=</span> 普通中学在校学生<span class="punctuation">,</span> </span><br><span class="line">    小学在校学生数_人 <span class="operator">=</span> 小学在校学生<span class="punctuation">,</span> </span><br><span class="line">    医疗卫生机构床位_床 <span class="operator">=</span> 医疗卫生机构床位<span class="punctuation">,</span></span><br><span class="line">    提供住宿的社会工作机构_个 <span class="operator">=</span> 提供住宿的民政服务机构<span class="punctuation">,</span> </span><br><span class="line">    提供住宿的社会工作机构床位_床 <span class="operator">=</span> 提供住宿的民政服务机构床位数</span><br><span class="line">  <span class="punctuation">)</span> <span class="operator">-&gt;</span> df6 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存成 xlsx</span></span><br><span class="line">df6 <span class="operator">%&gt;%</span> </span><br><span class="line">  writexl<span class="operator">::</span>write_xlsx<span class="punctuation">(</span><span class="string">&quot;2021年县市社会经济指标.xlsx&quot;</span><span class="punctuation">)</span> </span><br></pre></td></tr></table></figure>

<p>最后如果你想把该数据和之前年份的合并起来，只需要使用 <code>bind_rows()</code> 合并即可。</p>
<p>最后我们再使用该数据绘制一幅区县地图。这里使用的数据是我之前编辑过的一份 shp 数据。可以用于绘制带九段线小地图的中国地图。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggspatial<span class="punctuation">)</span></span><br><span class="line">read_sf<span class="punctuation">(</span><span class="string">&quot;chinacounty2020mini/chinacounty2020mini.shp&quot;</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> countymap </span><br><span class="line">read_sf<span class="punctuation">(</span><span class="string">&quot;chinacounty2020mini/chinacounty2020mini_line.shp&quot;</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> countyline </span><br><span class="line"></span><br><span class="line">countymap <span class="operator">%&gt;%</span> </span><br><span class="line">  filter<span class="punctuation">(</span><span class="operator">!</span><span class="built_in">is.na</span><span class="punctuation">(</span>objid<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> countymap </span><br></pre></td></tr></table></figure>

<p>以地区生产总值为例：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">df6 <span class="operator">%&gt;%</span> </span><br><span class="line">  select<span class="punctuation">(</span>县代码<span class="punctuation">,</span> 国内生产总值_万元<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span>v <span class="operator">=</span> 国内生产总值_万元 <span class="operator">/</span> <span class="number">10000</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> df7 </span><br></pre></td></tr></table></figure>

<p>缺失值使用所在市、所在省的均值填补，实在无法填补的设定为 -1：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">countymap <span class="operator">%&gt;%</span> </span><br><span class="line">  left_join<span class="punctuation">(</span>df7<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  group_by<span class="punctuation">(</span>省<span class="punctuation">,</span> 省代码<span class="punctuation">,</span> 市<span class="punctuation">,</span> 市代码<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span>mean1 <span class="operator">=</span> mean<span class="punctuation">(</span>v<span class="punctuation">,</span> na.rm <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         v <span class="operator">=</span> if_else<span class="punctuation">(</span><span class="built_in">is.na</span><span class="punctuation">(</span>v<span class="punctuation">)</span><span class="punctuation">,</span> mean1<span class="punctuation">,</span> v<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  ungroup<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  group_by<span class="punctuation">(</span>省<span class="punctuation">,</span> 省代码<span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span>mean2 <span class="operator">=</span> mean<span class="punctuation">(</span>v<span class="punctuation">,</span> na.rm <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         v <span class="operator">=</span> if_else<span class="punctuation">(</span><span class="built_in">is.na</span><span class="punctuation">(</span>v<span class="punctuation">)</span><span class="punctuation">,</span> mean2<span class="punctuation">,</span> v<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  ungroup<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span>v <span class="operator">=</span> if_else<span class="punctuation">(</span><span class="built_in">is.na</span><span class="punctuation">(</span>v<span class="punctuation">)</span><span class="punctuation">,</span> <span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span> v<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> df8 </span><br></pre></td></tr></table></figure>

<p>下面我们将绘制两种地图，一种是使用连续变量绘制，另一种是使用分类变量绘制，为此，我们对地区生产总值变量进行分组：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># v 的范围</span></span><br><span class="line"><span class="built_in">range</span><span class="punctuation">(</span>df8<span class="operator">$</span>v<span class="punctuation">)</span> </span><br><span class="line"><span class="comment">#&gt; [1]   -1.00 4748.06</span></span><br><span class="line">quantile<span class="punctuation">(</span>df8<span class="operator">$</span>v<span class="punctuation">,</span> seq<span class="punctuation">(</span>from <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span> to <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> <span class="built_in">length</span> <span class="operator">=</span> <span class="number">8</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  `[`<span class="punctuation">(</span><span class="number">2</span><span class="operator">:</span><span class="number">7</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  <span class="built_in">round</span><span class="punctuation">(</span>digits <span class="operator">=</span> <span class="number">2</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> cuts</span><br><span class="line"></span><br><span class="line">df8 <span class="operator">%&gt;%</span> </span><br><span class="line">  mutate<span class="punctuation">(</span>group <span class="operator">=</span> cut<span class="punctuation">(</span>v<span class="punctuation">,</span> breaks <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> cuts<span class="punctuation">,</span> <span class="number">5000</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                     include.lowest <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span></span><br><span class="line">                     labels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;无数据&quot;</span><span class="punctuation">,</span> <span class="string">&quot;0 ~ 65.35&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="string">&quot;65.35 ~ 109.36&quot;</span><span class="punctuation">,</span> <span class="string">&quot;109.36 ~ 154.74&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="string">&quot;154.74 ~ 229.96&quot;</span><span class="punctuation">,</span> <span class="string">&quot;229.96 ~ 328.96&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="string">&quot;328.96 ~ 521.38&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&gt; 521.38&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span>  <span class="operator">-&gt;</span> df9 </span><br></pre></td></tr></table></figure>

<p>countyline 变量还需要再处理下：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">countyline <span class="operator">%&gt;%</span> </span><br><span class="line">  tail<span class="punctuation">(</span>n <span class="operator">=</span> <span class="number">9</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  select<span class="punctuation">(</span><span class="built_in">class</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  filter<span class="punctuation">(</span><span class="built_in">class</span> <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;九段线&quot;</span><span class="punctuation">,</span> <span class="string">&quot;海岸线&quot;</span><span class="punctuation">,</span> <span class="string">&quot;小地图框格&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> countyline </span><br></pre></td></tr></table></figure>

<p>连续变量的绘制：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 绘制连续变量</span></span><br><span class="line">ggplot<span class="punctuation">(</span>df9<span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_sf<span class="punctuation">(</span>aes<span class="punctuation">(</span>fill <span class="operator">=</span> v<span class="punctuation">)</span><span class="punctuation">,</span> linewidth <span class="operator">=</span> <span class="number">0.001</span><span class="punctuation">,</span> color <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> countyline<span class="punctuation">,</span> aes<span class="punctuation">(</span>color <span class="operator">=</span> <span class="built_in">class</span><span class="punctuation">,</span> linewidth <span class="operator">=</span> <span class="built_in">class</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">          show.legend <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  scale_color_manual<span class="punctuation">(</span>values <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span></span><br><span class="line">    <span class="string">&quot;九段线&quot;</span> <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="string">&quot;海岸线&quot;</span> <span class="operator">=</span> <span class="string">&quot;#0055AA&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="string">&quot;小地图框格&quot;</span><span class="operator">=</span> <span class="string">&quot;black&quot;</span></span><br><span class="line">  <span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  scale_linewidth_manual<span class="punctuation">(</span>values <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span></span><br><span class="line">    <span class="string">&quot;九段线&quot;</span> <span class="operator">=</span> <span class="number">0.3</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="string">&quot;海岸线&quot;</span> <span class="operator">=</span> <span class="number">0.3</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="string">&quot;小地图框格&quot;</span><span class="operator">=</span> <span class="number">0.2</span></span><br><span class="line">  <span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  scale_fill_viridis_c<span class="punctuation">(</span>option <span class="operator">=</span> <span class="string">&quot;A&quot;</span><span class="punctuation">,</span> trans <span class="operator">=</span> <span class="string">&quot;log10&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  annotation_scale<span class="punctuation">(</span></span><br><span class="line">    width_hint <span class="operator">=</span> <span class="number">0.2</span><span class="punctuation">,</span></span><br><span class="line">    text_family <span class="operator">=</span> cnfont </span><br><span class="line">  <span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  annotation_north_arrow<span class="punctuation">(</span></span><br><span class="line">    location <span class="operator">=</span> <span class="string">&quot;tr&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    width <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    height <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    which_north <span class="operator">=</span> <span class="string">&quot;false&quot;</span><span class="punctuation">,</span></span><br><span class="line">    pad_x <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.5</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    pad_y <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.5</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    style <span class="operator">=</span> north_arrow_nautical<span class="punctuation">(</span></span><br><span class="line">      text_family <span class="operator">=</span> cnfont</span><br><span class="line">    <span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  guides<span class="punctuation">(</span>fill <span class="operator">=</span> guide_colorbar<span class="punctuation">(</span>title <span class="operator">=</span> <span class="string">&quot;地区生产总值（亿元）&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  theme_ipsum<span class="punctuation">(</span>base_family <span class="operator">=</span> cnfont<span class="punctuation">,</span> grid <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  theme<span class="punctuation">(</span>axis.text.x <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.text.y <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        legend.position <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.12</span><span class="punctuation">,</span> <span class="number">0.2</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        plot.background <span class="operator">=</span> element_rect<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> color <span class="operator">=</span> <span class="string">&quot;white&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  labs<span class="punctuation">(</span>title <span class="operator">=</span> <span class="string">&quot;2021 年中国各县地区生产总值（亿元）&quot;</span><span class="punctuation">,</span></span><br><span class="line">       subtitle <span class="operator">=</span> <span class="string">&quot;数据整理 &amp; 绘制：微信公众号 RStata&quot;</span><span class="punctuation">,</span></span><br><span class="line">       caption <span class="operator">=</span> <span class="string">&quot;数据来源：2022 年中国县域统计年鉴&quot;</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> p </span><br><span class="line"></span><br><span class="line">ggsave<span class="punctuation">(</span><span class="string">&quot;pic1.png&quot;</span><span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">8</span><span class="punctuation">,</span> device <span class="operator">=</span> png<span class="punctuation">)</span> </span><br></pre></td></tr></table></figure>

<p><img src="https://files.mdnice.com/user/1670/93141c85-6d06-4e0c-ac0d-4d4e6f69929a.png" alt=""></p>
<p>分类变量的绘制：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 绘制分类变量</span></span><br><span class="line">ggplot<span class="punctuation">(</span>df9<span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_sf<span class="punctuation">(</span>aes<span class="punctuation">(</span>fill <span class="operator">=</span> group<span class="punctuation">)</span><span class="punctuation">,</span> linewidth <span class="operator">=</span> <span class="number">0.001</span><span class="punctuation">,</span> color <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> countyline<span class="punctuation">,</span> aes<span class="punctuation">(</span>color <span class="operator">=</span> <span class="built_in">class</span><span class="punctuation">,</span> linewidth <span class="operator">=</span> <span class="built_in">class</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">          show.legend <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  scale_color_manual<span class="punctuation">(</span>values <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span></span><br><span class="line">    <span class="string">&quot;九段线&quot;</span> <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="string">&quot;海岸线&quot;</span> <span class="operator">=</span> <span class="string">&quot;#0055AA&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="string">&quot;小地图框格&quot;</span><span class="operator">=</span> <span class="string">&quot;black&quot;</span></span><br><span class="line">  <span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  scale_linewidth_manual<span class="punctuation">(</span>values <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span></span><br><span class="line">    <span class="string">&quot;九段线&quot;</span> <span class="operator">=</span> <span class="number">0.3</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="string">&quot;海岸线&quot;</span> <span class="operator">=</span> <span class="number">0.3</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="string">&quot;小地图框格&quot;</span><span class="operator">=</span> <span class="number">0.2</span></span><br><span class="line">  <span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  scale_fill_viridis_d<span class="punctuation">(</span>option <span class="operator">=</span> <span class="string">&quot;A&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  annotation_scale<span class="punctuation">(</span></span><br><span class="line">    width_hint <span class="operator">=</span> <span class="number">0.2</span><span class="punctuation">,</span></span><br><span class="line">    text_family <span class="operator">=</span> cnfont </span><br><span class="line">  <span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  annotation_north_arrow<span class="punctuation">(</span></span><br><span class="line">    location <span class="operator">=</span> <span class="string">&quot;tr&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    width <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    height <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    which_north <span class="operator">=</span> <span class="string">&quot;false&quot;</span><span class="punctuation">,</span></span><br><span class="line">    pad_x <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.5</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    pad_y <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.5</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    style <span class="operator">=</span> north_arrow_nautical<span class="punctuation">(</span></span><br><span class="line">      text_family <span class="operator">=</span> cnfont</span><br><span class="line">    <span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  guides<span class="punctuation">(</span>fill <span class="operator">=</span> guide_legend<span class="punctuation">(</span>title <span class="operator">=</span> <span class="string">&quot;地区生产总值（亿元）&quot;</span><span class="punctuation">,</span></span><br><span class="line">                             ncol <span class="operator">=</span> <span class="number">2</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  theme_ipsum<span class="punctuation">(</span>base_family <span class="operator">=</span> cnfont<span class="punctuation">,</span> grid <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  theme<span class="punctuation">(</span>axis.text.x <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">        axis.text.y <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">        legend.position <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.15</span><span class="punctuation">,</span> <span class="number">0.2</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">        plot.background <span class="operator">=</span> element_rect<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> color <span class="operator">=</span> <span class="string">&quot;white&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  labs<span class="punctuation">(</span>title <span class="operator">=</span> <span class="string">&quot;2021 年中国各县地区生产总值（亿元）&quot;</span><span class="punctuation">,</span></span><br><span class="line">       subtitle <span class="operator">=</span> <span class="string">&quot;数据整理 &amp; 绘制：微信公众号 RStata&quot;</span><span class="punctuation">,</span></span><br><span class="line">       caption <span class="operator">=</span> <span class="string">&quot;数据来源：2022 年中国县域统计年鉴&quot;</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> p </span><br><span class="line"></span><br><span class="line">ggsave<span class="punctuation">(</span><span class="string">&quot;pic2.png&quot;</span><span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">8</span><span class="punctuation">,</span> device <span class="operator">=</span> png<span class="punctuation">)</span> </span><br></pre></td></tr></table></figure>

<p><img src="https://mdniceczx.oss-cn-beijing.aliyuncs.com/20230421233046.png" alt=""></p>

  </div>
  
</article>

        
      
        
          <article class="article post archive-post" itemscope itemtype="http://schema.org/Article">
            <a class="archive-post-link" href="/posts/41662/">
              <strong class="archive-post-title" itemprop="name">2000～2022 年中国县域统计年鉴的数据</strong>
              <span class="archive-post-date"><time datetime="2023-04-21T11:25:00.000Z">2023-04-21</time></span>
            </a>
          </article>
        
      
        
          <article class="article post archive-post" itemscope itemtype="http://schema.org/Article">
            <a class="archive-post-link" href="/posts/32009/">
              <strong class="archive-post-title" itemprop="name">使用 Stata 进行数据可视化：绘图案例合集（一）</strong>
              <span class="archive-post-date"><time datetime="2023-04-21T11:21:00.000Z">2023-04-21</time></span>
            </a>
          </article>
        
      
        
          <article class="article post archive-post" itemscope itemtype="http://schema.org/Article">
            <a class="archive-post-link" href="/posts/17671/">
              <strong class="archive-post-title" itemprop="name">R 语言地理计算应用与地理数据可视化案例合集</strong>
              <span class="archive-post-date"><time datetime="2023-04-21T11:20:00.000Z">2023-04-21</time></span>
            </a>
          </article>
        
      
        
          <article class="article post archive-post" itemscope itemtype="http://schema.org/Article">
            <a class="archive-post-link" href="/posts/13387/">
              <strong class="archive-post-title" itemprop="name">Stata 编程案例合集（一）</strong>
              <span class="archive-post-date"><time datetime="2023-04-21T11:18:00.000Z">2023-04-21</time></span>
            </a>
          </article>
        
      
        
          <article class="article post archive-post" itemscope itemtype="http://schema.org/Article">
            <a class="archive-post-link" href="/posts/20729/">
              <strong class="archive-post-title" itemprop="name">1998～2014 年工企海关匹配结果</strong>
              <span class="archive-post-date"><time datetime="2023-04-21T11:14:00.000Z">2023-04-21</time></span>
            </a>
          </article>
        
      
        
          <article class="article post archive-post" itemscope itemtype="http://schema.org/Article">
            <a class="archive-post-link" href="/posts/21258/">
              <strong class="archive-post-title" itemprop="name">R 语言绘图案例合集（一）</strong>
              <span class="archive-post-date"><time datetime="2023-04-21T11:14:00.000Z">2023-04-21</time></span>
            </a>
          </article>
        
      
        
          <article class="article post archive-post" itemscope itemtype="http://schema.org/Article">
            <a class="archive-post-link" href="/posts/42578/">
              <strong class="archive-post-title" itemprop="name">Stata：如何为区县名称添加行政区划代码</strong>
              <span class="archive-post-date"><time datetime="2023-04-21T11:14:00.000Z">2023-04-21</time></span>
            </a>
          </article>
        
      
    </div>
  </div>
</div>
    <footer id="footer" class="wrapper">
  <div class="inner">
    <div id="footer-copyright">
      &copy; 2025 <a href="https://github.com/hexojs/hexo/graphs/contributors" rel="external nofollow noreferrer" target="_blank">RStata</a><br>
      Documentation licensed under <a href="http://creativecommons.org/licenses/by/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>.
    </div>
    <div id="footer-links">
      <a href="https://github.com/r-stata" rel="external nofollow noreferrer" class="footer-link" target="_blank"><i class="fa fa-github-alt"></i></a>

      <a href="/wechat" class="footer-link" target="_blank"><i class="fa fa-weixin"></i></a>
    </div>
  </div>
</footer>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <nav id="mobile-nav">
  <div id="mobile-nav-inner">
    <ul id="mobile-nav-list">
      <a href="/archives/" class="mobile-nav-link">归档</a><a href="/r-gallery/" class="mobile-nav-link">R 语言绘图案例</a><a href="/stata-gallery/" class="mobile-nav-link">Stata 绘图案例</a><a href="/rsdb2/" class="mobile-nav-link">RStata课程与数据库</a><a href="/templates/" class="mobile-nav-link">模板库</a><a href="/books/" class="mobile-nav-link">电子书</a><a href="/about/" class="mobile-nav-link">关于</a>
      <li class="mobile-nav-item">
        <a href="https://github.com/r-stata" class="mobile-nav-link" rel="external" target="_blank">GitHub</a>
      </li>
    </ul>
    
  </div>
  <div id="mobile-lang-select-wrap">
    <span id="mobile-lang-select-label"><i class="fa fa-globe"></i><span>简体中文</span></span>
    <select id="mobile-lang-select" data-canonical="">
      
        <option value="en">English</option>
      
        <option value="zh-tw">正體中文</option>
      
        <option value="zh-cn" selected>简体中文</option>
      
        <option value="ru">Русский</option>
      
        <option value="ko">한국어</option>
      
        <option value="pt-br">Português (Brasil)</option>
      
        <option value="th">ภาษาไทย</option>
      
    </select>
  </div>
</nav>
  <!-- Scripts -->
<!-- Cookie -->
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
<!-- build:js build/js/main.js -->

<script src="/js/lang_select.js"></script>


<script src="/js/mobile_nav.js"></script>

<!-- endbuild -->

<!-- Algolia -->


</body>
</html>